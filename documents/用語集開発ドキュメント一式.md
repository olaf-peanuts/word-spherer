# 用語集アプリ（Glossary App）プロジェクトドキュメント  
**作成日:** 2025‑12‑22 **バージョン:** 1.0.0  

---

## 1️⃣ プロジェクト憲章 / プロジェクト計画書

| 項目 | 内容 |
|------|------|
| **プロジェクト目的・背景** | - 社内の技術部門で AI が生成した用語・解説を一元管理し、検索性と再利用性を向上させる。<br>- 現在は個人の Markdown ファイルが散在しているため情報共有コストが高い。<br>- Azure AD による SSO で社内 PC の認証情報だけでアクセスできるようにし、管理負荷を削減する。 |
| **スコープ** | **対象機能** <br>1. 用語（Term）の CRUD<br>2. カテゴリ（Category）管理<br>3. Markdown → HTML 変換・ファイル保存（/data/md, /data/html）<br>4. 「See」「See Also」自己参照リンクの作成・整合性チェック<br>5. 全文検索（title、kanaReading、htmlContent）＋重み付けスコアリング<br>6. Azure AD SSO（OAuth2 Authorization Code + PKCE）<br>7. UI：SPA（React）で検索・一覧・詳細・エディタ画面<br>8. CI/CD（GitHub Actions → ACR → Azure App Service for Containers）<br>9. インフラ自動構築（OpenTofu） | **除外項目** <br>- 多言語翻訳機能（将来的に拡張予定）<br>- リアルタイム共同編集（Google Docs 風）<br>- 高度な分析・レコメンドエンジン |
| **成功基準 (KPI / MVP 定義)** | **MVP** <br>1. 社内ユーザーが Azure AD アカウントでログインし、用語の登録・検索・閲覧ができる<br>2. 「See」「See Also」リンクが DB の外部キーで必ず整合性を保つ<br>3. Markdown → HTML が自動変換され、ファイルシステムに永続化される<br>4. 検索結果の 95 % が期待した用語を上位 5 件に含む（精度）<br>**KPI** <br>- **検索応答時間**：平均 ≤ 200 ms、95 パーセンタイル ≤ 300 ms<br>- **可用性**：月間 SLA 99.9 %（ダウンタイム ≤ 43 分/月）<br>- **ユーザー採用率**：リリース後 30 日以内に社内技術部門の 80 % が利用開始<br>- **コード品質**：テストカバレッジ ≥ 80 %、ESLint エラー 0 件 |
| **主要ステークホルダーと役割** | - **プロダクトオーナー（IT 部門長）** – 要件優先順位、リリース承認<br>- **アーキテクト（本回答者）** – 技術選定・設計レビュー<br>- **フロントエンド開発者** – React SPA 実装<br>- **バックエンド開発者** – NestJS API、Prisma スキーマ実装<br>- **インフラ担当** – OpenTofu 定義、Azure リソース管理<br>- **セキュリティチーム** – Azure AD 設定・脆弱性スキャン<br>- **エンドユーザー（技術部門メンバー）** – 用語作成・検索利用 |
| **予算・リソース概算** | **人員** <br>• アーキテクト／リード 1 名 (0.5 FTE) <br>• フロントエンド開発者 2 名 (1 FTE 合計) <br>• バックエンド開発者 2 名 (1 FTE 合計) <br>• インフラ／CI‑CD エンジニア 1 名 (0.5 FTE) <br>**クラウドコスト（月額）** <br>• Azure App Service Plan B1 (2 台) – 約 $70<br>• Azure PostgreSQL Flexible Server (B‑Standard) – 約 $120<br>• Azure Files 500 GB – 約 $30<br>• Azure Container Registry – 約 $20<br>**合計（初期）**: 人件費 6 人月 × $8,000 ≈ **$48,000** + クラウド月額約 **$240** （TBD：実際の見積もりは Azure Pricing Calculator にて確定）。 |
| **タイムライン（マイルストーン）** | 1. **Kick‑off & 要件固め** – 2025‑01‑10 → 2025‑01‑31 <br>2. **インフラ構築 (OpenTofu)** – 2025‑02‑01 → 2025‑02‑15 <br>3. **バックエンド基盤（Prisma、API）** – 2025‑02‑16 → 2025‑03‑10 <br>4. **フロントエンド MVP 実装** – 2025‑03‑11 → 2025‑04‑05 <br>5. **検索・リンク自動生成実装** – 2025‑04‑06 → 2025‑04‑20 <br>6. **テスト自動化（Jest / Playwright）** – 2025‑04‑21 → 2025‑05‑10 <br>7. **ステージングデプロイ & ユーザ受入テスト** – 2025‑05‑11 → 2025‑05‑25 <br>8. **本番リリース (MVP)** – 2025‑06‑01 <br>9. **ポストリリース改善サイクル** – 2025‑06‑02 onward |
| **承認サインオフ** | - プロダクトオーナー：_____________________（日付）<br>- アーキテクト：_____________________（日付） |

---

## 2️⃣ 要件定義書

### 2.1 ユーザーストーリー / ユースケース一覧

| # | ユーザー | ストーリー |
|---|----------|------------|
| US‑01 | 社員 (認証済) | **用語を新規作成** できる。タイトル・Markdown 本文・カテゴリ・See/See Also を入力し、保存すると自動で slug が生成され、ファイルが `/data/md/<group>/<slug>.md` と `/data/html/...` に保存される。 |
| US‑02 | 社員 (認証済) | **自分が作成した用語** は **編集・削除** できる。 |
| US‑03 | 社員 (認証済) | 他人が作成した用語は **閲覧のみ** 可能で、編集ボタンは非表示になる。 |
| US‑04 | 社員 (認証済) | 用語一覧を **頭文字（英字・五十音行）ごとにアコーディオン** で展開し、50 件超えたら「あ」「い」…のサブグループに分割できる。 |
| US‑05 | 社員 (認証済) | **検索ボックス** にキーワードを入力 → **リアルタイムで候補表示**（最大 10 件）。タイトルヒットはスコア上位、本文ヒットは下位になるように重み付け。 |
| US‑06 | 社員 (認証済) | 用語詳細ページで **HTML がレンダリング** され、**See / See Also** リンクがクリック可能。リンク先が削除された場合は自動的に無効化（DB 整合性エラー防止）。 |
| US‑07 | 社員 (認証済) | **カテゴリ管理**：カテゴリの作成・階層化（親子）を行える（権限は管理者のみ）。 |
| US‑08 | 社員 (未認証) | アプリにアクセスしようとすると **Azure AD ログイン画面へリダイレクト**。認証後、トークンが取得され API 呼び出しの `Authorization: Bearer` ヘッダーに自動付与される。 |
| US‑09 | 運用担当 | Azure ポータルで **バックアップ**（Azure Files スナップショット）を手動またはスケジュール実行できる。 |
| US‑10 | 開発者 | CI/CD がプッシュ時に自動テスト → Docker イメージ作成 → ACR へプッシュ → Azure App Service のコンテナイメージ更新が走り、失敗した場合は **ロールバック** が可能。 |

### 2.2 機能要件（入力・出力・画面遷移・ビジネスロジック）

| 番号 | 機能 | 入力項目 | 出力 / 画面遷移 |
|------|------|----------|----------------|
| F‑01 | 用語作成 | `title`（256文字以内）<br>`markdownContent`<br>`language`（固定 ja）<br>`categoryId` (optional)<br>`seeIds[]`, `seeAlsoIds[]` (UUID 配列) | 成功 → `/terms/:slug` 詳細ページへリダイレクト<br>失敗 → バリデーションエラーメッセージ |
| F‑02 | 用語編集 | 同上 + `id`（パス） | 成功 → 詳細ページ更新<br>権限不足 → 403 エラー |
| F‑03 | 用語削除 | `id`（パス） | 成功 → ホームへリダイレクト<br>外部キー制約違反 → 400 エラーメッセージ |
| F‑04 | 検索 | クエリ文字列 `q` (GET) | JSON 配列 `{ id, title, slug, rank }`（上位 10 件） |
| F‑05 | 用語一覧取得（アコーディオン用） | 無し | JSON オブジェクト `{ groupKey: [{ id, title, slug }] }` |
| F‑06 | カテゴリ CRUD | `name`, `parentId?` | 同上（作成時は slug 生成） |
| F‑07 | 認証フロー | Azure AD の Authorization Code (PKCE) | アクセストークン (`JWT`) が取得でき、API 呼び出しに付与 |
| F‑08 | ファイル保存ロジック（バックエンド内部） | `slug`, `initialLetter`, `markdownContent` | Markdown → HTML 変換 (`marked`) → `/data/md/...` と `/data/html/...` に永続化 |
| F‑09 | 検索インデックス更新（DB トリガー） | DB の INSERT / UPDATE | `searchVector` が自動生成（title: 重み A、kanaReading: B、htmlContent: C） |
| F‑10 | リンク自動置換 | Markdown 本文、全用語リスト | 文章中に一致した単語を `<a href="/terms/{slug}">…</a>` に変換し HTML に埋め込む（保存時実行） |

### 2.3 非機能要件概要

| 項目 | 要求 |
|------|------|
| **パフォーマンス** | - 検索 API の平均応答 ≤ 200 ms<br>- 用語詳細ページの HTML レンダリング ≤ 150 ms |
| **可用性** | - SLA 99.9 %（月間ダウンタイム ≤ 43 分）<br>- Azure App Service の自動スケールアウト (B1 プラン) |
| **セキュリティ** | - Azure AD SSO（OAuth2 Authorization Code + PKCE）<br>- JWT 署名検証 (`passport-azure-ad`)<br>- TLS 1.2+ 終端（App Service デフォルト）<br>- ストレージ暗号化 (Azure Files のサーバー側暗号化) |
| **スケーラビリティ** | - コンテナイメージは水平に増やせる構成<br>- DB は Azure PostgreSQL Flexible Server の自動スケール（CPU/IO） |
| **保守性** | - CI/CD による自動デプロイ・ロールバック<br>- ログは JSON で stdout → Log Analytics に集約、30 日保持 |
| **国際化** | - UI は日本語と英語の両方に対応（i18n TBD） |
| **アクセシビリティ** | - WCAG AA レベルを満たす（カラーコントラスト、キーボード操作可） |

### 2.4 受入基準 (Acceptance Criteria)

| US ID | 基準 |
|-------|------|
| US‑01 | - タイトルが空でないこと<br>- slug が自動生成され DB の `unique` 制約に合格<br>- `/data/md/<group>/<slug>.md` と `/data/html/...` にファイルが作成される<br>- 返却された JSON に `slug` が含まれ、ブラウザは詳細ページへ遷移 |
| US‑02 | - 同一 `authorId` のみ PATCH/DELETE が成功（ステータス 200）<br>- 他ユーザーの更新リクエストは 403 |
| US‑04 | - アコーディオンが頭文字ごとにグルーピングされ、50 件超えたらサブグループが表示される<br>- UI がレスポンシブでモバイルでも操作可能 |
| US‑05 | - キーワード入力後 300 ms以内に候補リストが表示<br>- タイトルマッチはスコア上位、本文マッチは下位になる |
| US‑06 | - 詳細ページの HTML が正しくサニタイズされ XSS が発生しない<br>- See/See Also のリンクが有効かつ削除済み用語へのリンクは 404 ではなく非表示になる |
| US‑08 | - 未認証状態で `/` にアクセスすると Azure AD ログインへリダイレクト<br>- 認証後アクセストークンがローカルストレージに保存され、API 呼び出しの `Authorization` ヘッダーに自動付与 |
| US‑10 | - GitHub Actions が全テスト (Jest + Playwright) をパスしたらイメージを ACR にプッシュ<br>- デプロイ失敗時は前バージョンへ自動ロールバック（`az webapp config container set --slot staging` で検証） |

---

## 3️⃣ 非機能要件仕様書

| 項目 | 詳細 |
|------|------|
| **パフォーマンス目標** | - **検索 API**: 95 % のリクエストが < 300 ms、99 % が < 500 ms（PostgreSQL `pg_trgm` + GIN インデックス利用）<br>- **用語詳細取得**: 200 ms 未満で HTML を返す（キャッシュは未使用、将来 Redis キャッシュを検討） |
| **可用性・冗長構成 (SLA)** | - Azure App Service の **自動スケールアウト**（最小インスタンス 1、最大 3）<br>- PostgreSQL Flexible Server は **ゾーン冗長** 構成で障害時にフェイルオーバー<br>- Azure Files は Geo‑Redundant Storage (GRS) に設定（バックアップは別途スナップショット） |
| **セキュリティ要件** | - **認証方式**: Azure AD の OAuth2 Authorization Code + PKCE、アクセストークンは JWT。<br>- **暗号化**: TLS 1.2+ (HTTPS) → Azure Front Door/Custom Domain で終端；Azure Files はサーバー側暗号化（AES‑256）。<br>- **脆弱性基準**: OWASP Top 10 に対する自動スキャン (GitHub Dependabot, Snyk)。検出された CVE の修正は 7 日以内に行う。 |
| **スケーラビリティ・拡張性** | - コンテナイメージはレジストリ（ACR）でバージョン管理し、App Service が **Blue‑Green デプロイ** をサポート。<br>- 将来的に検索キャッシュ層 (Redis) か全文検索エンジン (Azure Cognitive Search) へ置き換えることが可能なインターフェースをサービス層で抽象化。 |
| **運用・保守要件** | - **バックアップ**: Azure Files の自動スナップショット（24 時間ごと、保持期間 30 日）<br>- **ログ保持**: Log Analytics に JSON ログを送信し、最低 30 日保存。クエリ例 `search * | where TimeGenerated > ago(30d)` <br>- **メンテナンスウィンドウ**: 毎月第1火曜 02:00‑04:00（DB のパッチ適用）<br>- **監視アラート**: CPU 使用率 > 80 %（5 分連続） → Azure Monitor アラート、Slack 通知 |

---

## 4️⃣ 画面設計書 (UI/UX Design Specification)

> **※ ワイヤーフレーム・モックアップは省略し、代わりに説明文と「TBD」画像参照**  

### 4.1 主要画面一覧

| ページ | 主な要素 |
|--------|----------|
| **Home（/）** | Header (ロゴ + ログイン/ログアウトボタン) <br>SearchBar (入力 → ディープリンク表示) <br>TermAccordion (頭文字別に折りたたみリスト) |
| **Term Detail (/terms/:slug)** | Breadcrumb <br>タイトル、HTML コンテンツ（`dangerouslySetInnerHTML`）<br>See / See Also セクション（リンク一覧）<br>Edit ボタン（所有者のみ表示） |
| **Edit / New Term (/edit/:id? )** | Form: Title (text) <br>Category selector (dropdown + “新規作成”モーダル) <br>MarkdownEditor (リアルタイムプレビュー) <br>See / See Also multi‑select（検索式のオートコンプリート）<br>保存ボタン |
| **Category Management (/categories)** | テーブル表示：カテゴリ名、スラッグ、親カテゴリ<br>新規作成・編集モーダル |

### 4.2 UI コンポーネント一覧と仕様

| コンポーネント | サイズ / 配置 | カラー | フォント |
|----------------|--------------|--------|----------|
| Header (高さ 64 px) | Flex: 左ロゴ、右認証ボタン | 背景 #003366、文字 #FFFFFF | Roboto, 16 pt |
| SearchBar | 横幅 100 %（max‑width 800 px）<br>入力フィールド height 40 px | ボーダー #CCCCCC、フォーカス時 #0066FF | Roboto, 14 pt |
| Accordion (details/summary) | summary 高さ 48 px、アイコン左側 | 背景 #F8F9FA、Hover #E2E6EA | Roboto, 15 pt |
| MarkdownEditor (MDEditor) | 幅 100 %（max‑width 900 px）<br>高さ 400 px | デフォルトテーマ（light） | Consolas / Monospace for codeブロック |
| ボタン（Primary） | 高さ 36 px、幅自動 | 背景 #0066CC、Hover #0055AA、文字 #FFFFFF | Roboto, 14 pt, border‑radius 4 px |
| フォームエラーメッセージ | 赤文字 (#D32F2F)、フォントサイズ 12 pt | – | – |

### 4.3 画面遷移図（フローチャート）  

```
[Login] --> [Home]
   ^                |
   |                v
[Logout] <-- [Term Detail] <--> [Edit/New Term]
   ^                ^
   |                |
[Error Page]    [Category Management]
```

*矢印はユーザー操作または自動リダイレクトを示す。*

### 4.4 アクセシビリティ要件

| 項目 | 要求 |
|------|------|
| カラーコントラスト | テキスト vs 背景の比率 ≥ 4.5:1（WCAG AA） |
| キーボード操作 | 全てのインタラクションは Tab/Enter で実行可能。`<details>` の開閉は Space キーでもトリガーできるようにカスタムハンドラを追加。 |
| ARIA ラベル | ボタン・入力フィールドに適切な `aria-label`、エラー表示に `role="alert"` を付与。 |
| フォーカスインジケータ | デフォルトのブラウザアウトラインは残すか、カスタムで 2 px の青い枠線を表示。 |
| スクリーンリーダー | 用語一覧は `<ul>`/`<li>`、見出しは正しい階層（h1→h3）でマークアップ。 |

### 4.5 インタラクション詳細

| UI 要素 | アニメーション / バリデーション |
|---------|-----------------------------------|
| SearchBar (入力) | ディレイ付きデバウンス（300 ms）後に API 呼び出し、結果フェードイン（0.2 s） |
| Accordion 展開 | `height` の CSS トランジション 0.25 s<br>アイコン回転アニメーション |
| フォーム送信 | バリデーションエラーは即時表示（`class="error"` が赤枠）<br>成功時はスナックバーで「保存しました」通知（2 秒表示） |
| MarkdownEditor | プレビュー領域はリアルタイム更新、入力遅延なし（内部 WebWorker により非同期変換） |

---

## 5️⃣ データモデル設計書

### 5.1 ER 図（テキストで表現）

```
[User] 1 ──< owns >── * [Term]
[Category] 1 ──< contains >── * [Term]
[Term] 1 ──< has many >── * [TermHistory]

self‑reference:
[Term] * ──< SEE / SEE_ALSO >── * [Term] (via TermSeeLink)

TermSeeLink
   PK: (sourceId, targetId, type)
   FK sourceId → Term.id
   FK targetId → Term.id
```

### 5.2 テーブル定義（Prisma スキーマに基づく）

| Table | カラム | 型 / 制約 | インデックス |
|-------|--------|-----------|--------------|
| **User** | `id` (PK) | UUID, `@default(uuid())` | - |
|  | `displayName` | VARCHAR(255) | - |
|  | `email` | VARCHAR(255) | - |
| **Category** | `id` (PK) | UUID | - |
|  | `name` | VARCHAR(100), `@unique` | - |
|  | `slug` | VARCHAR(150), `@unique` | - |
|  | `parentId` | UUID, nullable, FK → Category.id | - |
| **Term** | `id` (PK) | UUID | - |
|  | `title` | VARCHAR(256) | - |
|  | `slug` | VARCHAR(200), `@unique` | - |
|  | `language` | CHAR(2) default `'ja'` | - |
|  | `kanaReading` | TEXT | - |
|  | `initialLetter` | VARCHAR(10) | - |
|  | `subGroup` | VARCHAR(5), nullable | - |
|  | `markdownPath` | TEXT | - |
|  | `htmlPath` | TEXT | - |
|  | `markdownContent` | TEXT | - |
|  | `htmlContent` | TEXT | - |
|  | `searchVector` | TSVECTOR (PostgreSQL) | **GIN** (`@@index([searchVector], type: GIN)`) |
|  | `createdAt` | TIMESTAMP, default now() | - |
|  | `updatedAt` | TIMESTAMP, auto‑update | - |
|  | `authorId` | UUID, FK → User.id | - |
|  | `categoryId` | UUID, nullable, FK → Category.id | - |
| **TermHistory** | `id` (PK) | UUID | - |
|  | `termId` | UUID, FK → Term.id | - |
|  | `markdownContent` | TEXT | - |
|  | `htmlContent` | TEXT | - |
|  | `createdAt` | TIMESTAMP, default now() | - |
|  | `authorId` | UUID, FK → User.id | - |
| **TermSeeLink** | `sourceId` | UUID, PK part, FK → Term.id | - |
|  | `targetId` | UUID, PK part, FK → Term.id | - |
|  | `type` | ENUM('SEE','SEE_ALSO'), PK part | - |

### 5.3 正規化レベルと理由

- **第1正規形 (1NF)**：全てのカラムは原子値（配列は別テーブル `TermSeeLink` に分離）。  
- **第2正規形 (2NF)**：主キーが単一の `id` で、非キー属性は完全関数従属。  
- **第3正規形 (3NF)**：推移的依存は排除（例: `authorId` が User の PK に直接参照）。  

> 正規化によりデータ整合性が保証され、外部キー制約で **See/See Also** の参照整合性を徹底。

### 5.4 データ永続化戦略

| 層 | 技術 | 理由 |
|----|------|------|
| 永続ストレージ (RDB) | PostgreSQL (Azure Flexible Server) | ACID、フルテキスト検索（tsvector + GIN）に最適 |
| 大容量ファイル | Azure Files (SMB 共有) → コンテナの `/data` マウント | ファイルサイズが大きくても DB に持たせず、バックアップも容易 |
| キャッシュ層 (将来拡張) | Redis (Azure Cache for Redis) – TBD | 検索結果・HTML のキャッシュで応答時間をさらに短縮可能 |

---

## 6️⃣ API 設計書

### 6.1 エンドポイント一覧

| メソッド | URL | 認可 | 内容 |
|----------|-----|------|------|
| `POST`   | `/api/terms` | Bearer (Azure AD) | 用語作成（CreateTermDto） |
| `GET`    | `/api/terms/:slug` | 任意（公開） | 用語詳細取得（含 See / See Also） |
| `PATCH`  | `/api/terms/:id` | Bearer + 所有者チェック | 用語更新 |
| `DELETE` | `/api/terms/:id` | Bearer + 所有者チェック | 用語削除 |
| `GET`    | `/api/terms/search?q=...` | 任意 | キーワード検索（全文検索） |
| `GET`    | `/api/terms/grouped` | 任意 | 頭文字・サブグループ別にまとめた一覧（Accordion 用） |
| `POST`   | `/api/categories` | Bearer (管理者) | カテゴリ作成 |
| `GET`    | `/api/categories` | 任意 | カテゴリ一覧取得 |
| `PATCH`  | `/api/categories/:id` | Bearer (管理者) | カテゴリ更新 |
| `DELETE` | `/api/categories/:id` | Bearer (管理者) | カテゴリ削除 |
| `GET`    | `/healthz` | 任意 | アプリヘルスチェック（ステータス 200） |

### 6.2 リクエストパラメータ・ボディ構造

**CreateTermDto (POST /api/terms)**
```json
{
  "title": "string (max 256)",
  "markdownContent": "string",
  "language": "ja",                // optional, default 'ja'
  "categoryId": "uuid | null",
  "seeIds": ["uuid", "..."],       // optional
  "seeAlsoIds": ["uuid", "..."]    // optional
}
```

**UpdateTermDto (PATCH /api/terms/:id)**
```json
{
  "title?: "string",
  "markdownContent?: "string",
  "categoryId?: "uuid | null",
  "seeIds?: ["uuid"],
  "seeAlsoIds?: ["uuid"]
}
```

### 6.3 レスポンス例とステータスコード

| エンドポイント | 正常時 (200/201) | エラー例 |
|----------------|------------------|----------|
| `POST /terms` | **201 Created** <br>`{ "id": "...", "slug": "...", "title": "...", ... }` | 400 Bad Request（バリデーション失敗）<br>409 Conflict（slug 重複） |
| `GET /terms/:slug` | **200 OK** <br>`{ "id":"...", "title":"...", "htmlContent":"<p>…</p>", "seeLinks":[...], "seeAlsoLinks":[...] }` | 404 Not Found |
| `PATCH /terms/:id` | **200 OK** (更新後オブジェクト) | 403 Forbidden（非所有者）<br>400 Bad Request |
| `DELETE /terms/:id` | **204 No Content** | 403 Forbidden、400 Bad Request（外部キー制約） |
| `GET /terms/search?q=` | **200 OK** <br>`[ { "id":"...", "title":"...", "slug":"...", "rank":0.87 }, … ]` | - |
| `GET /healthz` | **200 OK** <br>`{ "status":"ok" }` | 503 Service Unavailable（DB 接続不可） |

### 6.4 認可方式

- **Azure AD OAuth2 Authorization Code + PKCE**：フロントは MSAL によりアクセストークン取得。バックエンドは `passport-azure-ad` の `BearerStrategy` で JWT を検証し、`req.user` に `{ userId, displayName, email }` が設定される。  
- **所有者チェック**：GlossaryService 内で `authorId === req.user.userId` を比較し、NG の場合は `ForbiddenException`（403）を投げる。

### 6.5 エラーハンドリング規約

| HTTP ステータス | フォーマット |
|-----------------|--------------|
| 400 | `{ "error":"BadRequest", "message":"<detail>" }` |
| 401 | `{ "error":"Unauthorized", "message":"Invalid or missing token" }` |
| 403 | `{ "error":"Forbidden", "message":"You are not allowed to perform this action" }` |
| 404 | `{ "error":"NotFound", "message":"Resource not found" }` |
| 409 | `{ "error":"Conflict", "message":"Slug already exists" }` |
| 500 | `{ "error":"InternalServerError", "message":"Unexpected error" }` |

エラーは **NestJS の Global Exception Filter** にて JSON 形式に統一。

---

## 7️⃣ アーキテクチャ設計書

### 7.1 全体構成図（テキスト）

```
[ユーザー端末] --HTTPS--> [Azure Front Door (optional) / Custom DNS] 
    |
    v
[App Service for Containers - Frontend] (Docker: Nginx + React)
    |   (reverse‑proxy /api/*)
    v
[App Service for Containers - API] (Docker: NestJS)
    |
    v
[Azure PostgreSQL Flexible Server] <---> [Azure Files Share] (mounted as /data)
```

- **外部サービス**: Azure AD（認証）、Azure Container Registry（イメージ保管）、Log Analytics（ログ・モニタリング）。

### 7.2 コンポーネント分割と責務

| コンポーネント | 主な責務 |
|----------------|----------|
| **React SPA** | UI/UX、クライアント側ルーティング、検索デバイダ、MSAL 認証フロー |
| **Nginx (frontend container)** | 静的ファイル配信、SPA の HTML5 ルーティング (`try_files`)、API リバースプロキシ |
| **NestJS API** | REST エンドポイント、認可・認証、ビジネスロジック（slug, kana, grouping）、ファイル I/O、検索クエリ生成 |
| **Prisma Service** | DB アクセス層、型安全な ORM、トランザクション管理 |
| **TermLinksService** | See/See Also の自己参照リンク作成・整合性チェック |
| **HealthController** | `/healthz` エンドポイント（Kubernetes 互換のヘルスチェック） |
| **CI/CD (GitHub Actions)** | ビルド、テスト、Docker イメージプッシュ、App Service デプロイ |
| **OpenTofu IaC** | Azure リソース作成・更新、ネットワーク構成、ロール割り当て |

### 7.3 デプロイメントモデル

- **コンテナ化**：バックエンド・フロントエンドはそれぞれ独立 Docker イメージ。Azure App Service for Containers がホストし、マネージド OS と自動スケーリングを利用。  
- **オンプレミス開発環境**：Docker Compose（ローカル）で `api`, `web`, `db` コンテナを起動し、同一ボリューム (`./data`) にファイル永続化。  
- **クラウド PaaS**：本番は Azure App Service (Linux) + PostgreSQL Flexible Server + Azure Files（SMB）。  

### 7.4 技術スタック選定理由

| 項目 | 候補 | 採用理由 |
|------|------|----------|
| **言語** | TypeScript (全体) | フロント・バックで同一言語、型安全、開発効率 |
| **バックエンドフレームワーク** | NestJS | モジュール化・DI が自然、Prisma との相性良好、テスト容易 |
| **ORM** | Prisma | 型生成、マイグレーション自動化、TS との統合が強力 |
| **DB** | PostgreSQL (Flexible Server) | フルテキスト検索（tsvector, GIN）、pgroonga による日本語形態素解析、ACID |
| **フロントエンド** | React + Vite | SPA の高速開発・ホットリロード、React エコシステムが成熟 |
| **Markdown Editor** | @uiw/react-md-editor (built on marked) | ライブプレビューが組み込み済み、軽量 |
| **認証** | Azure AD (MSAL) + passport-azure-ad | 社内 SSO と統合し、PKCE で安全なトークン取得 |
| **コンテナランタイム** | Docker + Nginx (frontend) / Node (backend) | 標準化されたイメージ、App Service for Containers がサポート |
| **IaC** | OpenTofu (Terraform 互換) | OSS、HCL 言語で Azure Provider が充実、既存 Terraform スキル流用可 |
| **CI/CD** | GitHub Actions + Azure CLI | GitHub にコードがあるのでシームレス、Azure へのデプロイが公式サポート |

### 7.5 パターン・アンチパターン

| パターン / アンチパターン | 適用場所 |
|----------------------------|----------|
| **Repository + Service** (Prisma as Repository) | `GlossaryService`、`CategoryService` 等で DB 操作を抽象化 |
| **DTO Validation** (`class-validator`) | コントローラのリクエストボディ検証 |
| **Strategy パターン**（認可） | `JwtAuthGuard` でトークン検証ロジック分離 |
| **Self‑Referencing Many‑to‑Many** (TermSeeLink) | 用語間リンク実装に必須 |
| **Anti‑Pattern: Large BLOB in DB** | ファイルは Azure Files に保存し、DB にはパスだけ保持（既に回避済み） |
| **Anti‑Pattern: Mixing Auth & Business Logic** | 認可チェックはガード・サービス層で実施、コントローラは薄く保つ |

---

## 8️⃣ インフラ設計書 / 環境構成図

### 8.1 ネットワークトポロジ（Azure）

```
[Internet] --HTTPS--> [Azure DNS] --> [Azure Front Door (optional) ]
                                           |
                                          TLS termination
                                           |
                               +-------------------------------+
                               |   Azure Virtual Network (VNet)|
                               +-------------------------------+
                                      |            |
                ------------------------|------------|------------------------
                |                        |            |                       |
          App Service (Frontend)   App Service (API)  PostgreSQL Flexible Server   Azure Files Share
                |                        |            |                       |
                +------ Private Endpoint ----+---- Private Endpoint -----------+
```

- **NSG**: フロント・API のサブネットはインターネットからの HTTPS（ポート 443）だけ許可。PostgreSQL と Azure Files はプライベートエンドポイント経由でのみアクセス。  
- **Service Endpoints / Private Link** を使用し、データ平面は VNet 内に閉じる。

### 8.2 サーバー/コンテナスペック

| リソース | スペック (推奨) |
|----------|----------------|
| App Service Plan (Linux) | **B1**（1 vCPU, 1.75 GB RAM）×2 インスタンス（自動スケール上限 3） |
| PostgreSQL Flexible Server | `General Purpose`、vCore 2、ストレージ 100 GB SSD、Zone‑Redundant |
| Azure Files (Standard) | 500 GB プロビジョンド、GRS 冗長化 |
| Container Registry (ACR) | Basic SKU, geo‑replication **TBD** |

### 8.3 CI/CD パイプライン構成

```
[GitHub] --push--> [.github/workflows/ci-cd.yml]
   |
   +-- Checkout → Install deps
   +-- Lint (ESLint) → Test (Jest, Playwright)
   +-- Build Docker images (frontend & backend)
   +-- az acr login → push images to ACR
   +-- az webapp config container set (frontend & api) 
   +-- (optional) Terraform apply (OpenTofu) for infra changes
   +-- Notify Slack / Teams on success/failure
```

- **ステージング環境**: `staging` スロットを用意し、プッシュ後に自動デプロイ → 手動で本番へスワップ。  
- **Rollback**: 失敗時は前のスロットに戻すか、`az webapp config container set --slot staging` で旧イメージを再指定。

### 8.4 DNS・ロードバランサ・CDN 設定

| 項目 | 内容 |
|------|------|
| **DNS** | `glossary.company.local`（社内）またはカスタムドメイン `glossary.example.com` を Azure DNS に登録し、CNAME → App Service のデフォルトホスト名。 |
| **ロードバランサ** | Azure Front Door (optional) で WAF と CDN キャッシュを有効化（静的 HTML/JS はキャッシュ TTL 1 h）。 |
| **CDN** | Front Door が自動的にエッジロケーションへ配信。バックエンド API は `Cache-Control: no-store` に設定し、キャッシュは行わない。 |

### 8.5 モニタリング・ログ収集設計

- **Log Analytics ワークスペース**：App Service の診断ログ（stdout）と PostgreSQL の監査ログを送信。  
- **メトリクス**：CPU、Memory、HTTP 4xx/5xx、Response Time、DB Connection Count を Azure Monitor に取り込み、アラートは Slack に通知。  
- **クエリ例**（Log Analytics）: `requests | where duration > 5000` → 長時間応答の検出。

---

## 9️⃣ セキュリティ設計書

### 9.1 脅威モデル (STRIDE)

| 脅威 | シナリオ | 緩和策 |
|------|----------|--------|
| **Spoofing** (偽装) | 攻撃者が偽の Azure AD トークンで API にアクセス | Azure AD の JWT 署名検証 (`passport-azure-ad`)、トークン有効期限チェック |
| **Tampering** (改ざん) | 悪意あるユーザーがリクエストボディを書き換える | `class-validator` によるサーバ側バリデーション、CSRF は不要（ヘッダーのみ） |
| **Repudiation** (否認) | 操作履歴が残らず後で責任を逃れる | すべての変更は `TermHistory` に保存し、Log Analytics に監査ログ出力 |
| **Information Disclosure** (情報漏洩) | データベースやファイルに未暗号化でアクセス | TLS 終端、Azure Storage のサーバー側暗号化、最小権限の RBAC（App Service のマネージド ID） |
| **Denial of Service** (DoS) | 大量リクエストで API を過負荷にする | Azure Front Door WAF Rate‑Limit ルール、App Service の自動スケーリング |
| **Elevation of Privilege** (権限昇格) | 非所有者が他ユーザーの用語を編集 | 所有者チェック (`authorId === req.user.userId`) と管理者ロール（Azure AD グループ）で制御 |

### 9.2 認証・認可フロー

1. **SPA** が `msal-browser` を使い Azure AD の Authorization Code + PKCE フローを開始。  
2. 成功するとアクセストークン (JWT) が取得され、ローカルストレージに保持（安全な HttpOnly Cookie は使用しないが、XSS 対策は必須）。  
3. **API** へリクエスト時、`Authorization: Bearer <token>` ヘッダーを付与。  
4. `passport-azure-ad` の `BearerStrategy` がトークンの署名・issuer・audience を検証し、`req.user` に Azure AD の `oid`, `name`, `email` を設定。  
5. **RBAC**: 所有者か管理者グループ (`company-glossary-admins`) であるかをサービス層で判定。

### 9.3 データ暗号化方針

| 項目 | 暗号化方式 |
|------|------------|
| **転送** (クライアント ↔ App Service) | TLS 1.2+（HTTPS） |
| **内部通信** (App Service → PostgreSQL, Azure Files) | プライベートエンドポイント上の暗号化は自動的に行われ、Azure Storage のサーバー側暗号化 (AES‑256) を使用 |
| **バックアップ** | Azure Backup で暗号化されたスナップショットを取得 |
| **シークレット管理** | GitHub Secrets と Azure Key Vault（将来的に拡張） |

### 9.4 OWASP Top 10 対策一覧

| OWASP # | 対策実装 |
|--------|----------|
| A1 – Injection | Prisma のパラメータ化クエリ、`$executeRaw` にもバインド変数使用 |
| A2 – Broken Authentication | Azure AD SSO + JWT 検証、短いトークン有効期限（1 h） |
| A3 – Sensitive Data Exposure | TLS 終端、Azure Storage 暗号化、ログは個人情報をマスク |
| A4 – XML External Entities (N/A) | API は JSON のみ受け付ける |
| A5 – Broken Access Control | 所有者チェック、管理者ロール、HTTP 403 で応答 |
| A6 – Security Misconfiguration | `helmet` ミドルウェア、CSP ヘッダー設定 (`Content‑Security‑Policy`) |
| A7 – XSS | React のデフォルトエスケープ、HTML コンテンツはサーバ側で `marked` に `sanitize:true` オプションを付与 |
| A8 – Insecure Deserialization (N/A) | JSON パーサは標準ライブラリ使用 |
| A9 – Using Components with Known Vulnerabilities | Dependabot と Snyk で依存関係スキャン、脆弱性が見つかれば PR を自動生成 |
| A10 – Insufficient Logging & Monitoring | Log Analytics に全リクエスト・例外を送信、監査ログ保持 90 日 |

### 9.5 インシデント対応手順

1. **検知**：Azure Monitor アラートが Slack に通知。  
2. **評価**：オンコールの SRE がアラート内容と Log Analytics を確認し、インシデントレベルを判定（P1‑P4）。  
3. **封じ込め**：必要に応じて App Service のスロットを `staging` に切り替えてトラフィック停止、または IP 制限で攻撃元ブロック。  
4. **根本原因調査**：ログ・トレース解析、コードリポジトリの該当コミット確認。  
5. **復旧**：修正パッチを作成し、ステージングへデプロイ後テスト → 本番スロットにスワップ。  
6. **報告**：インシデントレポート（発生日時、影響範囲、対応手順、再発防止策）を Confluence に記録。  

---

## 10️⃣ テスト計画書

| テストレベル | 主な対象 | 手法・ツール |
|--------------|----------|---------------|
| **単体テスト** | Service 層 (`GlossaryService`, `TermLinksService`), Utility 関数 (`slugify`, `kana`, `initialLetter`) | Jest + ts‑jest, 目標カバレッジ ≥ 80 % |
| **結合テスト** | Controller ↔ Service ↔ Prisma（DB） | SuperTest (HTTP リクエスト) + Testcontainers (PostgreSQL コンテナ) |
| **システムテスト** | フロントエンドとバックエンドの統合、認証フロー全体 | Playwright (E2E) – シナリオ: ログイン → 用語作成 → 検索 → 編集・削除 |
| **受入テスト** | ビジネス要件（MVP）全体 | 手動チェックリスト + 自動化された E2E スクリプト |
| **パフォーマンステスト** | `/terms/search` エンドポイント、同時アクセス 100 リクエスト/秒 | k6 (TBD) – 目標平均応答 ≤ 300 ms |
| **セキュリティテスト** | JWT 検証、入力サニタイズ、レートリミット | OWASP ZAP スキャン + Snyk（依存関係） |

#### テストケース作成基準

- **正しいパス** と **エラーパス** の両方を網羅  
- 境界値テスト (例: タイトル 256 文字、255 文字)  
- 所有者権限チェック（自分・他人）  
- Search の部分一致・全体一致・日本語形態素解析結果確認  

#### 品質指標

| 指標 | 目標 |
|------|------|
| **バグ密度** (defects / KLOC) | ≤ 0.5 |
| **テストカバレッジ** (statements) | ≥ 85 %（単体）<br>≥ 80 %（統合） |
| **CI 成功率** | 100 %（全ブランチで必須） |
| **E2E 実行時間** | ≤ 5 分／パイプライン |

---

## 11️⃣ テスト仕様書 / テストケースシート

> 以下は主要機能のサンプルテーブルです。実装時に **TestRail** 等で管理してください。

| TC ID | シナリオ | 前提条件 | 入力 | 期待結果 | 実行手順 |
|-------|----------|-----------|------|----------|----------|
| TC‑01 | 用語新規作成（所有者） | ログイン済み、アクセストークン取得 | POST `/api/terms` <br>`{ "title":"Async Await", "markdownContent":"## Async\\n説明…" }` | 201 Created, レスポンスに `slug:"async-await"` と `id` が含まれる。ファイルが `/data/md/A/async‑await.md` に作成される。 | 1. MSALでログイン → token取得<br>2. Postman/Playwrightでリクエスト送信 |
| TC‑02 | 用語編集（非所有者） | ユーザー A が作成、ユーザー B でログイン | PATCH `/api/terms/:id` (A の ID) <br>`{ "title":"Edited Title" }` | 403 Forbidden, エラーメッセージ「You are not allowed」 | 同上 |
| TC‑03 | 検索結果のスコアリング | 用語 A（タイトルにキーワード）・用語 B（本文に同キーワード）が存在 | GET `/api/terms/search?q=keyword` | JSON 配列で `A.rank > B.rank`、かつ両方が上位 5 件以内に収まる | ブラウザで検索バー入力 → デバウンス後 API 呼び出し結果確認 |
| TC‑04 | See / See Also 整合性チェック（削除禁止） | 用語 X が Y を See として参照中 | DELETE `/api/terms/:id` (Y の ID) | 400 Bad Request, メッセージ「Term is referenced by other terms」 | API 呼び出し後ステータスコード確認 |
| TC‑05 | アコーディオン表示のサブグループ分割 | 同一行に 55 件以上の用語が存在 | GET `/api/terms/grouped` | `initialLetter` のキーは「ア行-あ」「ア行-い」…とサブグループ化される JSON が返る | API 呼び出し → JSON 構造確認 |
| TC‑06 | Azure AD SSO フロー | ブラウザで未認証状態 | アプリ URL へアクセス | 自動リダイレクト → Azure AD ログイン画面 → 成功後トップページが表示される | 手動操作、ブラウザのネットワークタブで `code` パラメータ取得確認 |
| TC‑07 | バックアップ復元テスト（TBD） | Azure Files のスナップショット作成済み | スナップショットからファイルをリストア | 用語ページが正常に表示され、HTML が正しく読み込まれる | Azure Portal で手動リストア → アプリ再起動 |

---

## 12️⃣ リリースノート / デプロイメントガイド

### 12.1 バージョン情報
| バージョン | リリース日 | 主な変更点 |
|------------|------------|-------------|
| **1.0.0** | 2025‑06‑01 | 初期 MVP リリース：用語 CRUD、検索、See/See Also、Azure AD SSO、Docker コンテナ化、OpenTofu IaC |
| **1.1.0 (TBD)** | TBD | カテゴリ階層管理 UI 追加、検索結果キャッシュ（Redis）実装、アクセシビリティ改善（WCAG AA） |

### 12.2 新機能・改善点一覧 (v1.0.0)

| 項目 | 内容 |
|------|------|
| 用語 CRUD | タイトル自動 slug、Markdown → HTML 変換、ファイル保存 |
| 検索 | PostgreSQL `tsvector` + `pgroonga`（日本語形態素）で高速検索 |
| See / See Also | 自己参照 many‑to‑many テーブルで整合性保証 |
| SSO | Azure AD (PKCE) によるシングルサインオン |
| CI/CD | GitHub Actions + ACR → Azure App Service for Containers（Blue‑Green デプロイ） |
| IaC | OpenTofu でリソース自動構築、ロールベースのアクセス制御 |

### 12.3 既知の問題と回避策

| 問題 | 現象 | 回避策 |
|------|------|--------|
| 検索結果が大量になる場合にタイムアウト | 大規模データで `pgroonga` のインデックス再構築中に遅延 | インデックスのメンテナンスウィンドウを設定（夜間） |
| Markdown エディタの大型ファイルで UI が固まる | ブラウザ側の JavaScript GC に時間がかかる | ファイルサイズ上限 2 MB を設け、超過時はエラー表示 |
| Azure Files の SMB マウント遅延（起動時） | コンテナ起動直後にファイル書き込み失敗 | `initContainer` でマウントチェックスクリプトを走らせる（TBD） |

### 12.4 デプロイ手順（本番）

1. **コードのマージ** → `main` ブランチへ push。  
2. GitHub Actions が自動でテスト・ビルド → ACR に `glossary-api:<SHA>` と `glossary-frontend:<SHA>` をプッシュ。  
3. **ステージングデプロイ**：Actions の `staging` スロットに新しいイメージを適用し、ヘルスチェック (`/healthz`) が OK か確認。  
4. **本番リリース**：ステージングが正常なら、App Service の「Swap」ボタンで `production` スロットへ切り替える。  
5. **ロールバック**（失敗時）: App Service のスロット機能で直前のイメージに再度スワップ、または `az webapp config container set --slot production --docker-custom-image-name <previous‑tag>` を実行。

### 12.5 環境別差分

| 項目 | ステージング | 本番 |
|------|--------------|------|
| **App Service Plan** | B1 (2 インスタンス) | B1 (3 インスタンス、Auto‑scale max 3) |
| **データベース** | PostgreSQL `General Purpose` vCore 2, データサイズ 20 GB | 同上、データサイズ 100 GB（予測成長分） |
| **ファイルストレージ** | Azure Files Standard 200 GB | Azure Files Standard 500 GB |
| **環境変数** | `APP_ENV=staging` | `APP_ENV=production` |
| **ログ保持期間** | 30 日 | 90 日 |

---

## 13️⃣ 運用マニュアル

### 13.1 定期保守作業リスト

| 頻度 | 作業内容 | 手順・ツール |
|------|----------|--------------|
| **日次** | ログ確認（エラーレート、5xx） | Log Analytics クエリ `requests | where resultCode >= 500` → Slack アラート |
| **週次** | ヘルスチェック実行 (`/healthz`) | Azure Monitor の自動テストまたは curl スクリプト |
| **月次** | データベース容量・インデックス統計確認 | `psql -c "\dt+"`、`VACUUM ANALYZE`（必要に応じて） |
| **四半期** | Azure Files バックアップの検証 | Azure Backup のリストアテストを実施し、復元時間 ≤ 30 分か確認 |
| **年次** | セキュリティパッチ適用・依存関係更新 | Dependabot PR をマージ、`npm audit fix` 実行 |

### 13.2 障害時トラブルシューティングフロー

1. **アラート受領**（Slack） → 確認：CPU/Memory が上昇か、HTTP 5xx が増加か。  
2. **ログ取得**：Log Analytics で該当時間帯のリクエスト・例外を検索。  
3. **再現テスト**：ステージング環境で同様のリクエストを送信し、問題が再現できるか確認。  
4. **対策実施**：必要に応じてスロットへ切り替え、または `az webapp restart` でコンテナ再起動。  
5. **復旧報告**：インシデントレポートを作成し、次回のレビュー会議で共有。

### 13.3 ログ閲覧・分析手順

- **Azure Portal → Log Analytics ワークスペース** → 「Logs」タブで KQL クエリ実行。例:  

```kusto
requests
| where timestamp > ago(1h)
| summarize count() by resultCode, bin(timestamp, 5m)
| order by timestamp desc
```

- **CLI**：`az monitor log-analytics query --workspace <id> --query "<KQL>"`.

### 13.4 バックアップ / リカバリ手順

1. **バックアップ作成（自動）**：Azure Backup のスケジュールで Azure Files の毎日スナップショット取得。  
2. **リストア**：Portal → Storage Account → File share → 「Restore」ボタン → 復元日時を選択。  
3. **データベースバックアップ**：PostgreSQL Flexible Server は自動バックアップ（7 日保持）で、必要に応じて Point‑In‑Time リストア機能を使用。  

### 13.5 キャパシティプランニング指標

| メトリクス | 現在値 (例) | 閾値 (警告/危険) |
|------------|-------------|-----------------|
| **CPU 使用率**（App Service） | 45 % | 警告 > 70 %、危険 > 85 % |
| **メモリ使用量** | 1.2 GB / 1.75 GB | 警告 > 70 %、危険 > 90 % |
| **DB 接続数** | 120/200 | 警告 > 150、危険 > 180 |
| **ストレージ使用率（Azure Files）** | 260 GB / 500 GB | 警告 > 70 %、危険 > 90 % |

定期的に上記指標を Azure Monitor のアラートとして設定し、閾値超過時は自動でスケールアウトまたは担当者へ通知。

---

# 📎 付録

| ファイル名 | 内容 |
|------------|------|
| `docker-compose.yml` | ローカル開発用スタック（DB・API・Web） |
| `Dockerfile.backend` / `Dockerfile.frontend` | マルチステージビルドと Nginx 設定 |
| `open-tofu/*.tf` | Azure リソース（RG、ACR、App Service、PostgreSQL、Files）の IaC 定義 |
| `.github/workflows/ci-cd.yml` | CI/CD パイプライン全体フロー |
| `prisma/schema.prisma` | データモデルと検索トリガー定義 |
| `src/glossary/*` | NestJS 用語管理ロジック（CRUD、リンク処理） |
| `src/frontend/*` | React SPA コンポーネント・認証プロバイダー |
| `jest.config.js`, `.eslintrc.js`, `.prettierrc` | テスト・コード品質設定 |

---

**以上が用語集アプリ全体の設計・運用ドキュメントです。**  
各項目は **TBD**（未確定）として示した部分（例：正確な予算額、CDN 設定、スナップショット保持期間など）はプロジェクト開始後に関係部門と協議のうえ決定してください。  

質問や追加要件が出た場合は随時このドキュメントを更新し、GitHub の `docs/` ディレクトリでバージョン管理します。 🚀