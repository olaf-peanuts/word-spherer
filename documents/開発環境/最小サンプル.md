# Minimal full-stack app with Next.js, Django, and PostgreSQL on Dockerï¼ˆOSæŒ‡å®šãªã—ã®ã‚¹ãƒªãƒ ç‰ˆï¼‰

ã¯ã˜ã‚ã¦ã®ä¸€é€šã‚Šä½“é¨“ã‚’é‡è¦–ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆNext.js + TypeScriptï¼‰ãƒ»ãƒãƒƒã‚¯ï¼ˆDjango + RESTï¼‰ãƒ»DBï¼ˆPostgreSQLï¼‰ã‚’ Ubuntu 24.04 ä¸Šã§ Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦èµ·å‹•ã—ã€ã€Œã‚­ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã¨DBã®æ–‡å­—åˆ—ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã€ã§ãã‚‹æœ€å°æ§‹æˆã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã—ã€å¾Œã§ Azureãƒ»Terraform ã«æ‹¡å¼µã—ã‚„ã™ã„å½¢ã§ã™ã€‚

---

## Folder layout

ä»¥ä¸‹ã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼ˆæŒ‡å®šã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã«åˆã‚ã›ã¦ã„ã¾ã™ï¼‰ã€‚

```
/home/noguchi/dev/
â”œâ”€ apps/
â”‚  â”œâ”€ frontend-app1/
â”‚  â”‚  â”œâ”€ src/
â”‚  â”‚  â”‚  â”œâ”€ pages/
â”‚  â”‚  â”‚  â”‚  â”œâ”€ index.tsx
â”‚  â”‚  â”‚  â”‚  â””â”€ api/hello.ts
â”‚  â”‚  â”‚  â”œâ”€ components/
â”‚  â”‚  â”‚  â”‚  â””â”€ KeyForm.tsx
â”‚  â”‚  â”‚  â””â”€ lib/
â”‚  â”‚  â”‚     â””â”€ api.ts
â”‚  â”‚  â”œâ”€ public/
â”‚  â”‚  â”œâ”€ next.config.mjs
â”‚  â”‚  â”œâ”€ tsconfig.json
â”‚  â”‚  â”œâ”€ package.json
â”‚  â”‚  â””â”€ Dockerfile
â”‚  â””â”€ backend-app1/
â”‚     â”œâ”€ myproject/
â”‚     â”‚  â”œâ”€ myproject/
â”‚     â”‚  â”‚  â”œâ”€ __init__.py
â”‚     â”‚  â”‚  â”œâ”€ settings.py
â”‚     â”‚  â”‚  â”œâ”€ urls.py
â”‚     â”‚  â”‚  â””â”€ wsgi.py
â”‚     â”‚  â”œâ”€ messages/
â”‚     â”‚  â”‚  â”œâ”€ __init__.py
â”‚     â”‚  â”‚  â”œâ”€ admin.py
â”‚     â”‚  â”‚  â”œâ”€ apps.py
â”‚     â”‚  â”‚  â”œâ”€ migrations/
â”‚     â”‚  â”‚  â”‚  â””â”€ 0001_initial.py
â”‚     â”‚  â”‚  â”œâ”€ models.py
â”‚     â”‚  â”‚  â”œâ”€ serializers.py
â”‚     â”‚  â”‚  â””â”€ views.py
â”‚     â”‚  â””â”€ manage.py
â”‚     â”œâ”€ requirements.txt
â”‚     â””â”€ Dockerfile
â”œâ”€ common/
â”‚  â””â”€ docs/
â”‚     â””â”€ notes.md
â”œâ”€ infra/
â”‚  â”œâ”€ docker-compose.yml
â”‚  â”œâ”€ nginx/
â”‚  â”‚  â””â”€ nginx.conf
â”‚  â””â”€ scripts/
â”‚     â””â”€ wait-for.sh
â”œâ”€ db/
â”‚  â”œâ”€ init.sql
â”‚  â””â”€ migrations/
â””â”€ README.md
```

---

## Backend (Django + REST)

### backend-app1/requirements.txt

```
Django==5.1.2
djangorestframework==3.15.2
psycopg2-binary==2.9.9
gunicorn==23.0.0
```

### backend-app1/Dockerfile

```
# Ubuntu 24.04 base is implied by host, but use python slim to keep image small
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system deps needed for psycopg2
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY myproject/ ./myproject/

# Create non-root user
RUN useradd -m appuser
USER appuser

ENV DJANGO_SETTINGS_MODULE=myproject.myproject.settings

# Collect static not necessary in this minimal API, but kept for extension
EXPOSE 8000

CMD ["gunicorn", "myproject.myproject.wsgi:application", "--bind", "0.0.0.0:8000"]
```

### backend-app1/myproject/manage.py

```python
#!/usr/bin/env python
import os
import sys

def main():
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myproject.myproject.settings')
    from django.core.management import execute_from_command_line
    execute_from_command_line(sys.argv)

if __name__ == '__main__':
    main()
```

### backend-app1/myproject/myproject/__init__.py

```python
# empty
```

### backend-app1/myproject/myproject/settings.py

```python
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.environ.get("DJANGO_SECRET_KEY", "dev-secret-key")
DEBUG = os.environ.get("DJANGO_DEBUG", "1") == "1"
ALLOWED_HOSTS = ["*"]

INSTALLED_APPS = [
    "django.contrib.contenttypes",
    "django.contrib.auth",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "rest_framework",
    "messages",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
]

APPEND_SLASH = True

ROOT_URLCONF = "myproject.myproject.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {"context_processors": []},
    }
]

WSGI_APPLICATION = "myproject.myproject.wsgi.application"

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "HOST": os.environ.get("POSTGRES_HOST", "db"),
        "PORT": os.environ.get("POSTGRES_PORT", "5432"),
        "NAME": os.environ.get("POSTGRES_DB", "appdb"),
        "USER": os.environ.get("POSTGRES_USER", "appuser"),
        "PASSWORD": os.environ.get("POSTGRES_PASSWORD", "apppass"),
    }
}

LANGUAGE_CODE = "ja"
TIME_ZONE = "Asia/Tokyo"
USE_I18N = True
USE_TZ = True

STATIC_URL = "static/"
```

### backend-app1/myproject/myproject/urls.py

```python
from django.urls import path
from messages.views import MessageByKeyView

urlpatterns = [
    path("api/messages/<str:key>/", MessageByKeyView.as_view(), name="message-by-key"),
]
```

### backend-app1/myproject/myproject/wsgi.py

```python
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "myproject.myproject.settings")
application = get_wsgi_application()
```

### backend-app1/myproject/messages/apps.py

```python
from django.apps import AppConfig

class MessagesConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "messages"
```

### backend-app1/myproject/messages/models.py

```python
from django.db import models

class Message(models.Model):
    key = models.CharField(max_length=64, unique=True)
    text = models.TextField()

    def __str__(self):
        return f"{self.key}: {self.text[:32]}"
```

### backend-app1/myproject/messages/serializers.py

```python
from rest_framework import serializers
from .models import Message

class MessageSerializer(serializers.ModelSerializer):
    class Meta:
        model = Message
        fields = ["key", "text"]
```

### backend-app1/myproject/messages/views.py

```python
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework import status
from .models import Message
from .serializers import MessageSerializer

class MessageByKeyView(APIView):
    def get(self, request, key: str):
        try:
            msg = Message.objects.get(key=key)
            return Response(MessageSerializer(msg).data)
        except Message.DoesNotExist:
            return Response({"detail": "Not found"}, status=status.HTTP_404_NOT_FOUND)
```

### backend-app1/myproject/messages/admin.py

```python
from django.contrib import admin
from .models import Message

@admin.register(Message)
class MessageAdmin(admin.ModelAdmin):
    list_display = ("key", "text")
```

### backend-app1/myproject/messages/migrations/0001_initial.py

```python
from django.db import migrations, models

class Migration(migrations.Migration):
    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name='Message',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('key', models.CharField(max_length=64, unique=True)),
                ('text', models.TextField()),
            ],
        ),
    ]
```

---

## Frontend (Next.js + TypeScript)

### frontend-app1/package.json

```json
{
  "name": "frontend-app1",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3000",
    "build": "next build",
    "start": "next start -p 3000",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.2.17",
    "react": "18.3.1",
    "react-dom": "18.3.1"
  },
  "devDependencies": {
    "typescript": "5.6.3",
    "@types/react": "18.3.11",
    "@types/node": "20.12.12"
  }
}
```

### frontend-app1/package-lock.json

npmã‚³ãƒãƒ³ãƒ‰ã§package-lock.jsonã‚’ç”Ÿæˆã™ã‚‹ã€‚

```bash
npm i --package-lock-only
```

### frontend-app1/tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "es2020"],
    "jsx": "react-jsx",
    "module": "ESNext",
    "moduleResolution": "Node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": {}
  },
  "include": ["src"]
}
```

### frontend-app1/next.config.mjs

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  reactStrictMode: true,
  // Backend is served via nginx at /api
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://backend:8000/api/:path*'
      }
    ];
  }
};
export default nextConfig;
```

### frontend-app1/src/lib/api.ts

```ts
export async function fetchMessageByKey(key: string): Promise<{ key: string; text: string } | null> {
  const res = await fetch(`/api/messages/${encodeURIComponent(key)}`);
  if (res.ok) {
    return res.json();
  }
  return null;
}
```

### frontend-app1/src/components/KeyForm.tsx

```tsx
import { useState } from "react";
import { fetchMessageByKey } from "../lib/api";

export default function KeyForm() {
  const [key, setKey] = useState("");
  const [result, setResult] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setResult(null);
    if (!key.trim()) {
      setError("ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    const data = await fetchMessageByKey(key.trim());
    if (data) {
      setResult(data.text);
    } else {
      setError("è©²å½“ã™ã‚‹ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }
  };

  return (
    <div style={{ maxWidth: 480, margin: "2rem auto", fontFamily: "system-ui, sans-serif" }}>
      <h1>ã‚­ãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—</h1>
      <form onSubmit={onSubmit}>
        <input
          value={key}
          onChange={(e) => setKey(e.target.value)}
          placeholder="ä¾‹: hello"
          style={{ width: "100%", padding: "0.5rem", marginBottom: "0.5rem" }}
        />
        <button type="submit" style={{ padding: "0.5rem 1rem" }}>
          å–å¾—
        </button>
      </form>
      {result && <p style={{ marginTop: "1rem" }}>çµæœ: {result}</p>}
      {error && <p style={{ marginTop: "1rem", color: "crimson" }}>{error}</p>}
    </div>
  );
}
```

### frontend-app1/src/pages/index.tsx

```tsx
import KeyForm from "../components/KeyForm";

export default function Home() {
  return <KeyForm />;
}
```

### frontend-app1/src/pages/api/hello.ts

```ts
export default function handler(_req: any, res: any) {
  res.status(200).json({ status: "ok" });
}
```

### frontend-app1/Dockerfile

```
FROM node:20-slim AS deps
WORKDIR /app
COPY package.json package-lock.json* ./
# RUN npm ci
RUN npm install
RUN npm audit fix --force

FROM node:20-slim AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

FROM node:20-slim AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY package.json ./
EXPOSE 3000
CMD ["npm", "start"]
```

---

## Database initialization

### db/init.sql

```sql
CREATE TABLE IF NOT EXISTS messages (
    id BIGSERIAL PRIMARY KEY,
    key VARCHAR(64) UNIQUE NOT NULL,
    text TEXT NOT NULL
);

INSERT INTO messages (key, text) VALUES
    ('hello', 'ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œï¼'),
    ('bye', 'ã•ã‚ˆã†ãªã‚‰ã€ã¾ãŸã­ï¼'),
    ('info', 'ã“ã‚Œã¯PostgreSQLã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚µãƒ³ãƒ—ãƒ«æ–‡å­—åˆ—ã§ã™ã€‚')
ON CONFLICT (key) DO NOTHING;
```

æ³¨æ„ï¼šDjango ã®ãƒ¢ãƒ‡ãƒ«åã¯ messages_message ã¨ãªã‚‹ã®ãŒæ¨™æº–ã§ã™ãŒã€æœ€åˆã¯ã‚·ãƒ³ãƒ—ãƒ«ã« SQL ã‚’ä½¿ã£ã¦å­¦ç¿’æ„å›³ã©ãŠã‚Šã€Œã‚­ãƒ¼ã¨æ–‡å­—åˆ—ã€ã‚’è©¦ã›ã‚‹ã‚ˆã†ã€ç›´æ¥ãƒ†ãƒ¼ãƒ–ãƒ« messages ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚Django ã‹ã‚‰ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ« messages.Message ã‚’ä½¿ã„ã¾ã™ãŒã€ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ API çµŒç”±ã®å­¦ç¿’ãŒä¸»ç›®çš„ãªã®ã§ã€åˆæœŸå€¤ã¯ SQL ã§æŠ•å…¥ã—ã¦ã„ã¾ã™ã€‚å¾Œã§ Django ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ORMã«å¯„ã›ã‚‹ç·´ç¿’ã‚‚ã§ãã¾ã™ã€‚

---

## Nginx reverse proxy (optional but aligned with your plan)

### infra/nginx/nginx.conf

```
events {}

http {
    server {
        listen 80;

        # Frontend
        location / {
            proxy_pass http://frontend:3000;
            proxy_set_header Host $host;
        }

        # Backend API (direct path, also reachable via Next.js rewrites)
        location /api/ {
            proxy_pass http://backend:8000/api/;
            proxy_set_header Host $host;
        }
    }
}
```

---

## Compose and helper

### infra/scripts/wait-for.sh

```bash
#!/usr/bin/env bash
# tiny wait-for helper
set -e
host="$1"
shift
until nc -z "$host" "$1"; do
  echo "waiting for $host:$1..."
  sleep 1
done
```

Make it executable:
```
chmod +x /home/name/dev/infra/scripts/wait-for.sh
```

### infra/docker-compose.yml

```yaml
version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d appdb"]
      interval: 5s
      timeout: 3s
      retries: 10

  backend:
    build:
      context: ../apps/backend-app1
    environment:
      DJANGO_SECRET_KEY: dev-secret-key
      DJANGO_DEBUG: "1"
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
      POSTGRES_DB: appdb
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
    depends_on:
      db:
        condition: service_healthy
    command: >
      bash -lc "
      python myproject/manage.py migrate &&
      gunicorn myproject.myproject.wsgi:application --bind 0.0.0.0:8000
      "
    ports:
      - "8000:8000"

  frontend:
    build:
      context: ../apps/frontend-app1
    depends_on:
      - backend
    environment:
      NODE_ENV: production
    ports:
      - "3000:3000"

  nginx:
    image: nginx:stable
    depends_on:
      - frontend
      - backend
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"

volumes:
  pgdata:
```

---

## README and notes

### README.md

```md
# Minimal full-stack app (Next.js + Django + PostgreSQL on Docker)

- Frontend: Next.js + TypeScript
- Backend: Django + DRF
- DB: PostgreSQL
- Reverse proxy: Nginx (optional but included)

## Run

1. Install Docker & Compose on Ubuntu 24.04 (see below).
2. cd infra
3. docker compose build
4. docker compose up -d
5. Access:
   - Frontend via Nginx: http://localhost/
   - API via Nginx: http://localhost/api/messages/hello
   - Direct frontend: http://localhost:3000
   - Direct backend: http://localhost:8000/api/messages/hello

## Stop
docker compose down

## Seeded keys
- hello
- bye
- info

### common/docs/notes.md

```md
- Next.js rewrites /api/* to backend, so frontend can call /api/messages/:key.
- Nginx routes / -> frontend, /api -> backend; useful for production parity.
- After this works, integrate Azure (Container Apps/App Service) and Terraform.
```

---

## How to run on Ubuntu 24.04

### 1. Prepare Docker

- Install packages:
  - sudo apt update
  - sudo apt install -y ca-certificates curl gnupg
- Add Dockerâ€™s official GPG key:
  - sudo install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - sudo chmod a+r /etc/apt/keyrings/docker.gpg
- Setup repository:
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release; echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
- Install:
  - sudo apt update
  - sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
- Enable and add your user:
  - sudo systemctl enable --now docker
  - sudo usermod -aG docker $USER
  - Log out/in or run new shell: newgrp docker

### 2. Build and start

- **Move to compose directory:**
  - cd /home/name/dev/infra
- **Build images:**
  - docker compose build
- **Start services:**
  - docker compose up -d
- **Check health:**
  - docker compose ps
  - docker logs backend

### 3. Verify

- **Frontend (Nginx):** http://localhost/
- **Try keys:**
  - å…¥åŠ›ã«ã€Œhelloã€ã€Œbyeã€ã€Œinfoã€ã‚’å…¥ã‚Œã¦ã€Œå–å¾—ã€ã‚’æŠ¼ã™
- **API directly:**
  - http://localhost/api/messages/hello
- **Direct service ports (optional):**
  - Frontend: http://localhost:3000
  - Backend: http://localhost:8000/api/messages/hello

---

## What youâ€™ll learn as you run it

- **Next.jsã®å½¹å‰²:** Reactã‚¢ãƒ—ãƒªã‚’SSR/SSGã§ãã‚‹æ çµ„ã¿ã€‚/pages/index.tsx ãŒãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã€ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ /api/messages/:key ã¸ãƒ•ã‚§ãƒƒãƒã€‚
- **Django + DRF:** Modelï¼ˆMessageï¼‰â†’ Serializer â†’ View(APIView) â†’ URL ã§ REST ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›ã€‚
- **PostgreSQL:** init.sqlã§ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã€‚Djangoã®migrateã§ã‚¢ãƒ—ãƒªã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚ç®¡ç†å¯èƒ½ã€‚
- **Docker Compose:** dbãƒ»backendãƒ»frontendãƒ»nginxã®4ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¸€æ‹¬èµ·å‹•ã€‚ä¾å­˜é–¢ä¿‚ã¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§é †åºåˆ¶å¾¡ã€‚
- **Nginxãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·:** / ã¯ãƒ•ãƒ­ãƒ³ãƒˆã€/api ã¯ãƒãƒƒã‚¯ã«æŒ¯ã‚Šåˆ†ã‘ã€‚å®Ÿé‹ç”¨ã«è¿‘ã„æ§‹æˆã‚’ä½“é¨“ã€‚

---

## Next steps (optional, when ready)

- **ãƒ¦ãƒ¼ã‚¶ç®¡ç†ï¼ˆå¿…é ˆè¦ä»¶ï¼‰:** Djangoã®authã‚’ä½¿ã„ã€djoserã‚„django-allauthã§APIãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã‚’è¿½åŠ ã€‚
- **ORMä¸»å°ã«ç§»è¡Œ:** init.sqlã§ã¯ãªãã€Djangoã® fixtures ã‚„ migrationï¼‹loaddata ã§ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã€‚
- **CI/CD:** GitHub Actionsã§ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰â†’ACRãƒ—ãƒƒã‚·ãƒ¥â†’Terraform(OpenTofu)ã§ Azure Container Apps/DB/Storage ã‚’ä½œæˆã€‚
- **ç’°å¢ƒå¤‰æ•°ç®¡ç†:** .env ãƒ•ã‚¡ã‚¤ãƒ«ã¨ secrets ã‚’å°å…¥ã—ã€æœ¬ç•ªç”¨ã« DEBUG=0ã€SECURE settingsã€CORSè¨­å®šãªã©ã‚’è¿½åŠ ã€‚

å¿…è¦ãªã‚‰ã€Terraformã®æœ€å°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆACR/Container Apps/PostgreSQL/Flexible Serverï¼‰ã‚‚æ¬¡ã«ç”¨æ„ã—ã¾ã™ã€‚ã“ã“ã¾ã§ã®å‹•ä½œç¢ºèªãŒæ¸ˆã‚“ã ã‚‰å£°ã‚’ã‹ã‘ã¦ãã ã•ã„ã€‚

---

# æœ€å°æ§‹æˆï¼ˆOSå›ºå®šç‰ˆï¼‰

ã„ã„è¦–ç‚¹ã§ã™ã­ ğŸ‘ã€‚Dockerfile ã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ **Ubuntu 24.04** ã«å›ºå®šã™ã‚‹å ´åˆã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’æ•´ç†ã—ã¾ã™ã€‚

---

## âœ… ãƒ¡ãƒªãƒƒãƒˆ

- **ãƒ›ã‚¹ãƒˆOSã¨ã®è¦ªå’Œæ€§**  
  - ã‚²ã‚¹ãƒˆOSã‚‚ãƒ›ã‚¹ãƒˆã‚‚ Ubuntu 24.04 ãªã‚‰ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°ãŒå°‘ãªãã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒã—ã‚„ã™ã„ã€‚

- **è±Šå¯Œãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**  
  - Ubuntu ã¯ apt ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå……å®Ÿã—ã¦ã„ã‚‹ãŸã‚ã€AIç³»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„é–‹ç™ºãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã§å…¥ã‚ŒãŸã„ã¨ãã«ä¾¿åˆ©ã€‚

- **é•·æœŸã‚µãƒãƒ¼ãƒˆ (LTS)**  
  - Ubuntu 24.04 ã¯ LTS ç‰ˆãªã®ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒé•·æœŸé–“æä¾›ã•ã‚Œã‚‹ã€‚é•·æœŸé‹ç”¨ã«å®‰å¿ƒã€‚

- **å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„**  
  - Ubuntu ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„æƒ…å ±ãŒå¤šãã€ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã«æ¤œç´¢ã§è§£æ±ºã—ã‚„ã™ã„ã€‚

---

## âš ï¸ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- **ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãŒå¤§ãã„**  
  - `ubuntu:24.04` ã¯è»½é‡ãª `python:3.12-slim` ã‚„ `node:20-slim` ã‚ˆã‚Šã‚‚æ•°ç™¾ MB å˜ä½ã§å¤§ãããªã‚‹ã€‚  
  - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¸€åº¦ã§ã‚‚ã€ãƒ“ãƒ«ãƒ‰ã‚„ CI/CD ã§ã®è»¢é€ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å½±éŸ¿ã™ã‚‹ã€‚

- **ãƒ“ãƒ«ãƒ‰é€Ÿåº¦ãŒé…ããªã‚‹**  
  - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤šã„åˆ†ã€ä¸è¦ãªã‚‚ã®ã‚‚å«ã¾ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‚„ãƒ“ãƒ«ãƒ‰ãŒã‚„ã‚„é‡ã„ã€‚

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã§ã®æ”»æ’ƒå¯¾è±¡ãŒåºƒã„**  
  - ä½™è¨ˆãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¥ã£ã¦ã„ã‚‹åˆ†ã€è„†å¼±æ€§ã®å¯¾è±¡ç¯„å›²ãŒåºƒãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

- **å…¬å¼è¨€èªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®æœ€é©åŒ–ãŒãªã„**  
  - ä¾‹ãˆã° `python:3.12-slim` ã‚„ `node:20-slim` ã¯ Python/Node ç”¨ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ãŒã€Ubuntu ãƒ™ãƒ¼ã‚¹ã ã¨è‡ªåˆ†ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã€‚

---

## ğŸ“Œ ã¾ã¨ã‚

- **Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹** â†’ é–‹ç™ºç’°å¢ƒã¨æƒãˆãŸã„ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æŸ”è»Ÿã«ä½¿ã„ãŸã„å ´åˆã«æœ‰åˆ©ã€‚  
- **è¨€èªå°‚ç”¨ slim ãƒ™ãƒ¼ã‚¹** â†’ è»½é‡ãƒ»é«˜é€Ÿãƒ»ã‚»ã‚­ãƒ¥ã‚¢ã§ CI/CD ã«å‘ã„ã¦ã„ã‚‹ã€‚  

ğŸ‘‰ æœ€åˆã®å­¦ç¿’ãƒ»å®Ÿé¨“ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ **Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹**ã§çµ±ä¸€ã™ã‚‹ã¨ç†è§£ã—ã‚„ã™ã„ã§ã™ã€‚  
ğŸ‘‰ æœ¬ç•ªç’°å¢ƒã‚„ CI/CD ã§ã¯ **slim ã‚¤ãƒ¡ãƒ¼ã‚¸**ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨åŠ¹ç‡çš„ã§ã™ã€‚  

---

ã‚ãªãŸã®ã‚±ãƒ¼ã‚¹ã ã¨ã€Œã¾ãšã¯ä¸€åº¦ã ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ç’°å¢ƒã‚’æƒãˆãŸã„ã€ã¨ã„ã†ç›®çš„ãªã®ã§ã€Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹ã§å§‹ã‚ã‚‹ã®ã¯åˆç†çš„ã§ã™ã€‚å¾Œã§è»½é‡åŒ–ã—ãŸã„ã¨ãã« slim ç³»ã«ç§»è¡Œã™ã‚‹ã®ãŒè‰¯ã„æµã‚Œã§ã™ã­ã€‚  

---

## **Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹ã® Dockerfile** ã«æ›¸ãæ›ãˆãŸå…·ä½“ä¾‹

Python ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ Node ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸¡æ–¹ã‚’ Ubuntu ãƒ™ãƒ¼ã‚¹ã«ã—ãŸå ´åˆã®æœ€å°æ§‹æˆã§ã™ã€‚

---

## ğŸ”¹ Backend (Django + REST, Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹)

`apps/backend-app1/Dockerfile`

```dockerfile
# Ubuntu 24.04 ã‚’ãƒ™ãƒ¼ã‚¹ã«åˆ©ç”¨
FROM ubuntu:24.04

# ç’°å¢ƒå¤‰æ•°
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-venv \
    build-essential libpq-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY myproject/ ./myproject/

EXPOSE 8000

CMD ["gunicorn", "myproject.myproject.wsgi:application", "--bind", "0.0.0.0:8000"]
```

---

## ğŸ”¹ Frontend (Next.js + TypeScript, Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹)

`apps/frontend-app1/Dockerfile`

```dockerfile
# Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹
FROM ubuntu:24.04

# Node.js ã¨ npm ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    curl gnupg \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json package-lock.json* ./
RUN npm ci

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY . .

RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

---

## âœ… Ubuntu ãƒ™ãƒ¼ã‚¹ã«ã—ãŸãƒ¡ãƒªãƒƒãƒˆ

- é–‹ç™ºç’°å¢ƒã¨å®Œå…¨ä¸€è‡´ â†’ ãƒ›ã‚¹ãƒˆã‚‚ã‚²ã‚¹ãƒˆã‚‚ Ubuntu 24.04 ãªã®ã§ã€Œå‹•ã„ãŸã®ã«æœ¬ç•ªã§å‹•ã‹ãªã„ã€ãŒæ¸›ã‚‹  
- apt ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè±Šå¯Œ â†’ AI ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„è¿½åŠ ãƒ„ãƒ¼ãƒ«ã‚’ç°¡å˜ã«å°å…¥ã§ãã‚‹  
- LTS ã‚µãƒãƒ¼ãƒˆ â†’ é•·æœŸçš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæä¾›ã•ã‚Œã‚‹  

## âš ï¸ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãŒå¤§ãã„ï¼ˆæ•°ç™¾ MB å˜ä½ã§å¢—ãˆã‚‹ï¼‰  
- ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒé•·ããªã‚‹  
- slim ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚ˆã‚Šã‚‚ä¸è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤šãã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒåºƒãŒã‚‹  

---

## ğŸš€ å®Ÿè¡Œæ–¹æ³•

1. **ãƒ“ãƒ«ãƒ‰**
   ```bash
   cd /home/name/dev/infra
   docker compose build
   ```

2. **èµ·å‹•**
   ```bash
   docker compose up -d
   ```

3. **ã‚¢ã‚¯ã‚»ã‚¹**
   - ãƒ•ãƒ­ãƒ³ãƒˆ: http://localhost/  
   - API: http://localhost/api/messages/hello  

---

ğŸ‘‰ æœ€åˆã¯ **Ubuntu 24.04 ãƒ™ãƒ¼ã‚¹**ã§ã€Œç’°å¢ƒã‚’æƒãˆã‚‹ã€ã“ã¨ã‚’å„ªå…ˆã—ã€æ…£ã‚Œã¦ããŸã‚‰ **slim ã‚¤ãƒ¡ãƒ¼ã‚¸**ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨åŠ¹ç‡çš„ã§ã™ã€‚  

---

## 1. Dockerfileã‚’Ubuntuãƒ™ãƒ¼ã‚¹ã«å…¥ã‚Œæ›¿ãˆã‚‹ã ã‘ã§å¤§ä¸ˆå¤«ã‹ï¼Ÿ

åŸºæœ¬çš„ã«ã¯ **Dockerfileã‚’ `ubuntu:24.04` ãƒ™ãƒ¼ã‚¹ã«æ›¸ãæ›ãˆã‚‹ã ã‘ã§å‹•ä½œã—ã¾ã™**ã€‚ãŸã ã—æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

- **è¨€èªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å°å…¥ãŒå¿…è¦**  
  - Python ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ â†’ `apt install python3 python3-pip` ã‚’å¿…ãšå…¥ã‚Œã‚‹  
  - Node ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ `curl` + NodeSource ã§ Node.js ã‚’å…¥ã‚Œã‚‹  
  â†’ ã¤ã¾ã‚Šã€`python:3.12-slim` ã‚„ `node:20-slim` ã®ã‚ˆã†ãªå°‚ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã¯æœ€åˆã‹ã‚‰å…¥ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’ã€è‡ªåˆ†ã§è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã®é•ã„**  
  - Ubuntu ãƒ™ãƒ¼ã‚¹ã¯ `apt` ã§ä¾å­˜ã‚’å…¥ã‚Œã‚‹ã®ã§ã€Dockerfileã®è¨˜è¿°ãŒå°‘ã—é•·ããªã‚‹  
  - ä¾å­˜é–¢ä¿‚ã‚’å¿˜ã‚Œã‚‹ã¨ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š

- **ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹**  
  - ã“ã‚Œã¯ä¸€åº¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã®ã§ã€å­¦ç¿’ãƒ»æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯å¤§ããªå•é¡Œã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ğŸ‘‰ ã¾ã¨ã‚ã‚‹ã¨ã€ŒDockerfileã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã ã‘ã€ã§ã¯ãªãã€**Pythonã‚„Nodeã‚’aptçµŒç”±ã§å°å…¥ã™ã‚‹è¡Œã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ã€ã¨ã„ã†ç‚¹ã ã‘æ³¨æ„ã™ã‚Œã°OKã§ã™ã€‚

---

## 2. Azureã‚’ä½¿ã‚ãšã«ã€Proxmoxä¸Šã®åˆ¥VMã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ä¾¡å€¤ã¯ã‚ã‚‹ã‹ï¼Ÿ

ã“ã‚Œã¯ **å¤§ã„ã«ä¾¡å€¤ãŒã‚ã‚Šã¾ã™**ã€‚ç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

- **ã‚¯ãƒ©ã‚¦ãƒ‰ã«è¡Œãå‰ã®ç·´ç¿’ç’°å¢ƒ**  
  - Proxmoxä¸Šã®VMã¯ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒŸãƒ‹ãƒãƒ¥ã‚¢ç‰ˆã€ã¨ã—ã¦æ‰±ãˆã‚‹ã®ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆãƒ»ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ãƒ»ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ãªã©ã‚’å®‰å…¨ã«è©¦ã›ã¾ã™ã€‚

- **CI/CDã®å‰æ®µéš**  
  - Docker Composeã§è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç«‹ã¡ä¸Šã’ã‚‹ â†’ VMã«ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ å‹•ä½œç¢ºèª  
  - ã“ã®æµã‚Œã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¿’å¾—ã—ã¦ã‹ã‚‰Terraform/Azureã«ç§»è¡Œã™ã‚‹ã¨ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚

- **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åŠ›ãŒã¤ã**  
  - VMé–“é€šä¿¡ã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã€ãƒãƒ¼ãƒˆå…¬é–‹ãªã©ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã‚‚å¿…é ˆã«ãªã‚‹çŸ¥è­˜ã‚’äº‹å‰ã«ä½“é¨“ã§ãã¾ã™ã€‚

- **ã‚³ã‚¹ãƒˆã‚¼ãƒ­ã§è©¦ã›ã‚‹**  
  - Azureã¯èª²é‡‘ãŒç™ºç”Ÿã—ã¾ã™ãŒã€Proxmoxä¸Šã®VMãªã‚‰ç„¡æ–™ã§ç¹°ã‚Šè¿”ã—è©¦ã›ã‚‹ã€‚

---

## âœ… çµè«–

- Dockerfileã¯ã€Œãƒ™ãƒ¼ã‚¹ã‚’Ubuntuã«å¤‰ãˆã‚‹ã€ï¼‹ã€Œãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’aptã§å°å…¥ã™ã‚‹ã€ã ã‘ã§OKã€‚  
- Proxmoxä¸Šã®VMã«ã¾ãšãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹ã®ã¯ **éå¸¸ã«ä¾¡å€¤ãŒã‚ã‚‹**ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã«ç§»ã™å‰ã®ç·´ç¿’ç’°å¢ƒã¨ã—ã¦æœ€é©ã§ã™ã€‚  

---

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã¯ã€**Proxmoxä¸Šã®VMã«ã“ã®Composeç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ‰‹é †**ã‚’æ•´ç†ã™ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚  
ä¾‹ãˆã°ã€ŒVMã‚’2å°ç”¨æ„ã—ã¦ã€1å°ã«DBã€ã‚‚ã†1å°ã«ãƒ•ãƒ­ãƒ³ãƒˆï¼‹ãƒãƒƒã‚¯ã‚’ç½®ãã€ãªã©ã®æ§‹æˆã‚’è©¦ã™ã¨ã€Azureã®åˆ†æ•£æ§‹æˆã«è¿‘ã„ä½“é¨“ãŒã§ãã¾ã™ã€‚  

---

ã„ã„ã§ã™ã­ã€ã§ã¯ **Proxmoxä¸Šã§è©¦ã™ãŸã‚ã®å…·ä½“çš„ãªVMæ§‹æˆ** ã‚’ææ¡ˆã—ã¾ã™ã€‚Azureã«è¡Œãå‰ã®ç·´ç¿’ã¨ã—ã¦ã€Œè¤‡æ•°VMã«åˆ†ã‘ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã™ã‚‹ã®ã¯ã¨ã¦ã‚‚ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚  

---

## ğŸ¯ ç›®çš„
- **ã‚¯ãƒ©ã‚¦ãƒ‰æ§‹æˆã®ç–‘ä¼¼ä½“é¨“**  
  â†’ DBã¨ã‚¢ãƒ—ãƒªã‚’åˆ¥VMã«åˆ†ã‘ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚„ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã‚’ç†è§£ã§ãã‚‹ã€‚  
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»é‹ç”¨ã®ç·´ç¿’**  
  â†’ VMã”ã¨ã«ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚„ãƒãƒ¼ãƒˆå…¬é–‹ã‚’è¨­å®šã™ã‚‹ç·´ç¿’ã«ãªã‚‹ã€‚  

---

## ğŸ–¥ï¸ VMæ§‹æˆä¾‹ï¼ˆProxmoxä¸Šï¼‰

### VM1: **Databaseã‚µãƒ¼ãƒ**
- **OS**: Ubuntu Server 24.04 LTS  
- **å½¹å‰²**: PostgreSQL ã‚’ç¨¼åƒã•ã›ã‚‹  
- **ã‚¹ãƒšãƒƒã‚¯ç›®å®‰**:  
  - CPU: 2 vCPU  
  - RAM: 4GB  
  - Disk: 20GB  
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ VM2 ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹  
- **ãƒãƒ¼ãƒˆå…¬é–‹**: 5432 (PostgreSQL)  
- **åˆæœŸåŒ–**: `init.sql` ã‚’æµã—è¾¼ã‚“ã§ã‚­ãƒ¼ã¨æ–‡å­—åˆ—ã‚’ç™»éŒ²  

---

### VM2: **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ**
- **OS**: Ubuntu Server 24.04 LTS  
- **å½¹å‰²**: Docker Composeã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰(Next.js)ï¼‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(Django)ï¼‹Nginxã‚’ç¨¼åƒ  
- **ã‚¹ãƒšãƒƒã‚¯ç›®å®‰**:  
  - CPU: 4 vCPU  
  - RAM: 8GB  
  - Disk: 40GB  
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: VM1ã®DBã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«è¨­å®š  
- **ãƒãƒ¼ãƒˆå…¬é–‹**:  
  - 80 (Nginx â†’ ãƒ•ãƒ­ãƒ³ãƒˆ/ãƒãƒƒã‚¯)  
  - 3000 (Next.jsç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã€é–‹ç™ºæ™‚ã®ã¿)  
  - 8000 (Djangoç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã€é–‹ç™ºæ™‚ã®ã¿)  

---

## ğŸ”— ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ
- Proxmoxã® **ãƒ–ãƒªãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** ã‚’åˆ©ç”¨ã—ã¦ã€ä¸¡VMãŒåŒã˜LANã«å±ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚  
- ä¾‹:  
  - VM1 (DB): 192.168.100.10  
  - VM2 (App): 192.168.100.20  
- Djangoã® `settings.py` ã® `POSTGRES_HOST` ã‚’ `192.168.100.10` ã«å¤‰æ›´ã€‚  

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚¤ãƒ¡ãƒ¼ã‚¸
1. **VM1ã«PostgreSQLã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   sudo apt update
   sudo apt install postgresql
   sudo -u postgres createdb appdb
   sudo -u postgres createuser appuser -P   # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
   psql -U appuser -d appdb -f /home/name/dev/db/init.sql
   ```

2. **VM2ã«Dockerç’°å¢ƒã‚’æ§‹ç¯‰**
   ```bash
   sudo apt update
   sudo apt install docker.io docker-compose-plugin
   ```

3. **VM2ã§docker-compose.ymlã‚’ä¿®æ­£**
   - `db` ã‚µãƒ¼ãƒ“ã‚¹ã¯å‰Šé™¤ï¼ˆVM1ã«ä»»ã›ã‚‹ï¼‰  
   - `backend` ã®ç’°å¢ƒå¤‰æ•° `POSTGRES_HOST=192.168.100.10` ã«å¤‰æ›´  

4. **VM2ã§èµ·å‹•**
   ```bash
   cd /home/name/dev/infra
   docker compose up -d
   ```

5. **ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹**
   - http://192.168.100.20/  
   - ã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨ VM1 ã®DBã‹ã‚‰æ–‡å­—åˆ—ãŒè¿”ã£ã¦ãã‚‹  

---

## âœ… ã¾ã¨ã‚
- VM1: **PostgreSQLå°‚ç”¨**ï¼ˆè»½é‡ï¼‰  
- VM2: **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å°‚ç”¨**ï¼ˆDocker Composeã§ãƒ•ãƒ­ãƒ³ãƒˆï¼‹ãƒãƒƒã‚¯ï¼‹Nginxï¼‰  
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯ Proxmox ã®ãƒ–ãƒªãƒƒã‚¸ã§åŒä¸€LANã«ç½®ã  
- ã“ã‚Œã§ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã®åˆ†æ•£æ§‹æˆã€ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®‰å…¨ã«ä½“é¨“ã§ãã¾ã™  

---

ğŸ‘‰ ã“ã®æ§‹æˆã§è©¦ã™ã¨ã€Azureã«ç§»è¡Œã—ãŸã¨ãã«ã€ŒApp Service / Container Appsã€ã¨ã€ŒAzure Database for PostgreSQLã€ã‚’åˆ†ã‘ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒç›´æ„Ÿçš„ã«ç†è§£ã§ãã¾ã™ã€‚  

æ¬¡ã¯ã€**docker-compose.yml ã‚’ VMåˆ†å‰²ç”¨ã«ä¿®æ­£ã—ãŸå…·ä½“ä¾‹**ã‚’è¦‹ãŸã„ã§ã™ã‹ï¼Ÿ

ã„ã„æµã‚Œã§ã™ã­ âœ¨  
ã§ã¯ã¾ãš **VMåˆ†å‰²ç”¨ã® docker-compose.yml ä¿®æ­£ç‰ˆ**ã‚’ç¤ºã—ãŸã‚ã¨ã€Terraform/OpenTofu ãŒã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç™»å ´ã™ã‚‹ã‹ã‚’æ•´ç†ã—ã¾ã™ã€‚

---

## ğŸ”¹ VMåˆ†å‰²ç”¨ docker-compose.ymlï¼ˆAppã‚µãƒ¼ãƒå´ï¼‰

VM1ï¼ˆDBå°‚ç”¨ï¼‰ã« PostgreSQL ã‚’ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã§ã€Composeãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ `db` ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ¥ç¶šå…ˆã‚’ VM1 ã®IPã«å¤‰æ›´ã—ã¾ã™ã€‚

`infra/docker-compose.yml`ï¼ˆä¿®æ­£ç‰ˆï¼‰

```yaml
version: "3.9"

services:
  backend:
    build:
      context: ../apps/backend-app1
    environment:
      DJANGO_SECRET_KEY: dev-secret-key
      DJANGO_DEBUG: "1"
      POSTGRES_HOST: 192.168.100.10   # VM1ã®DBã‚µãƒ¼ãƒIP
      POSTGRES_PORT: "5432"
      POSTGRES_DB: appdb
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
    command: >
      bash -lc "
      python myproject/manage.py migrate &&
      gunicorn myproject.myproject.wsgi:application --bind 0.0.0.0:8000
      "
    ports:
      - "8000:8000"

  frontend:
    build:
      context: ../apps/frontend-app1
    depends_on:
      - backend
    environment:
      NODE_ENV: production
    ports:
      - "3000:3000"

  nginx:
    image: nginx:stable
    depends_on:
      - frontend
      - backend
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
```

ğŸ‘‰ VM1 ã« PostgreSQL ã‚’å…¥ã‚Œã¦ã€VM2 ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ `POSTGRES_HOST=192.168.100.10` ã«æ¥ç¶šã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ”¹ Terraform(OpenTofu)ã¯ã„ã¤ç™»å ´ã™ã‚‹ã‹ï¼Ÿ

å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—çš„ã«ã¯ä»¥ä¸‹ã®é †ç•ªãŒè‡ªç„¶ã§ã™ï¼š

1. **ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆå˜ä¸€VMï¼‰ã§Docker Composeã‚’å‹•ã‹ã™**  
   â†’ ãƒ•ãƒ­ãƒ³ãƒˆãƒ»ãƒãƒƒã‚¯ãƒ»DBãŒåŒã˜ãƒã‚·ãƒ³ã§å‹•ãã“ã¨ã‚’ç¢ºèªã€‚

2. **Proxmoxä¸Šã§VMã‚’åˆ†ã‘ã¦ãƒ‡ãƒ—ãƒ­ã‚¤**  
   â†’ VM1ã«DBã€VM2ã«ã‚¢ãƒ—ãƒªã‚’ç½®ãã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¶Šã—ã«é€šä¿¡ã™ã‚‹ç·´ç¿’ã€‚  
   â†’ ã“ã‚ŒãŒã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã®åˆ†æ•£æ§‹æˆã€ã®ç–‘ä¼¼ä½“é¨“ã€‚

3. **Terraform/OpenTofuã®ç™»å ´**  
   â†’ VMã§ã®æ§‹æˆãŒç†è§£ã§ããŸã‚‰ã€Azureã«ç§»è¡Œã™ã‚‹éš›ã«ã€ŒVMã§ã‚„ã£ãŸã“ã¨ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã€ã™ã‚‹ã€‚  
   â†’ å…·ä½“çš„ã«ã¯ï¼š
   - Azure Container Apps / App Service ã« VM2ã®ã‚¢ãƒ—ãƒªã‚’ç½®ã  
   - Azure Database for PostgreSQL ã« VM1ã®DBã‚’ç½®ã  
   - Azure Storage ã«é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚„AIãƒ¢ãƒ‡ãƒ«ã‚’ç½®ã  
   - ã“ã‚Œã‚‰ã‚’ Terraform(OpenTofu) ã§ IaC åŒ–ã—ã¦å†ç¾å¯èƒ½ã«ã™ã‚‹  

---

## âœ… ã¾ã¨ã‚

- **ä»Šã¯VMåˆ†å‰²ã®Composeä¿®æ­£**ã§ã€Œã‚ªãƒ³ãƒ—ãƒ¬ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã”ã£ã“ã€ã‚’ä½“é¨“ã™ã‚‹æ®µéšã€‚  
- **Terraform/OpenTofuã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**ã§ã€Azureã«ç§»è¡Œã™ã‚‹ã¨ãã«ã€ŒVMã§ã‚„ã£ãŸæ§‹æˆã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã€ã™ã‚‹ãŸã‚ã«ç™»å ´ã—ã¾ã™ã€‚  
- ã¤ã¾ã‚Šã€**VMã§ã®ç·´ç¿’ãŒçµ‚ã‚ã£ãŸã‚‰Terraformã‚’å°å…¥**ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚  

---

ğŸ‘‰ æ¬¡ã¯ã€Terraform/OpenTofuã§ **Azure Database for PostgreSQL ã¨ Container Apps ã‚’æœ€å°æ§‹æˆã§ä½œã‚‹ã‚³ãƒ¼ãƒ‰ä¾‹** ã‚’è¦‹ãŸã„ã§ã™ã‹ï¼Ÿ



äº†è§£ã—ã¾ã—ãŸ âœ¨  
ã§ã¯ã€**Terraform(OpenTofu)ã§ Azure ã«æœ€å°æ§‹æˆã‚’ä½œã‚‹ã‚³ãƒ¼ãƒ‰ä¾‹**ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€ŒVMã§åˆ†ã‘ãŸæ§‹æˆã€ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ç§»ã™ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã€**Appï¼ˆã‚³ãƒ³ãƒ†ãƒŠï¼‰ï¼‹DBï¼ˆPostgreSQLï¼‰** ã‚’ IaC åŒ–ã—ã¾ã™ã€‚

---

## ğŸ¯ ã‚´ãƒ¼ãƒ«
- **Azure Container Apps** ã«ãƒ•ãƒ­ãƒ³ãƒˆï¼‹ãƒãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤  
- **Azure Database for PostgreSQL Flexible Server** ã«DBã‚’ä½œæˆ  
- **Terraform(OpenTofu)** ã§ã‚³ãƒ¼ãƒ‰åŒ–ã—ã€å†ç¾å¯èƒ½ã«ã™ã‚‹  

---

## ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼ˆinfra/terraformï¼‰

```
infra/terraform/
â”œâ”€ main.tf
â”œâ”€ variables.tf
â”œâ”€ outputs.tf
â””â”€ provider.tf
```

---

## ğŸ”¹ provider.tf

```hcl
terraform {
  required_version = ">= 1.6.0"
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
  }
}

provider "azurerm" {
  features {}
}
```

---

## ğŸ”¹ variables.tf

```hcl
variable "resource_group_name" {
  default = "rg-dev-app"
}

variable "location" {
  default = "japaneast"
}

variable "postgres_admin_user" {
  default = "appuser"
}

variable "postgres_admin_password" {
  default = "apppass123!"
}
```

---

## ğŸ”¹ main.tf

```hcl
# ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
resource "azurerm_resource_group" "rg" {
  name     = var.resource_group_name
  location = var.location
}

# PostgreSQL Flexible Server
resource "azurerm_postgresql_flexible_server" "db" {
  name                = "pg-flex-dev"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  administrator_login = var.postgres_admin_user
  administrator_password = var.postgres_admin_password
  version             = "16"

  storage_mb          = 32768
  sku_name            = "B_Standard_B1ms"
}

resource "azurerm_postgresql_flexible_server_database" "appdb" {
  name      = "appdb"
  server_id = azurerm_postgresql_flexible_server.db.id
  charset   = "UTF8"
  collation = "en_US.UTF8"
}

# Container Apps ç’°å¢ƒ
resource "azurerm_container_app_environment" "env" {
  name                = "cae-dev"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
}

# Backend ã‚³ãƒ³ãƒ†ãƒŠ
resource "azurerm_container_app" "backend" {
  name                         = "backend-app"
  container_app_environment_id = azurerm_container_app_environment.env.id
  resource_group_name          = azurerm_resource_group.rg.name
  revision_mode                = "Single"

  template {
    container {
      name   = "backend"
      image  = "myregistry.azurecr.io/backend:latest"
      cpu    = 0.5
      memory = "1Gi"

      env {
        name  = "POSTGRES_HOST"
        value = azurerm_postgresql_flexible_server.db.fqdn
      }
      env {
        name  = "POSTGRES_DB"
        value = azurerm_postgresql_flexible_server_database.appdb.name
      }
      env {
        name  = "POSTGRES_USER"
        value = var.postgres_admin_user
      }
      env {
        name  = "POSTGRES_PASSWORD"
        value = var.postgres_admin_password
      }
    }
  }

  ingress {
    external_enabled = true
    target_port      = 8000
  }
}

# Frontend ã‚³ãƒ³ãƒ†ãƒŠ
resource "azurerm_container_app" "frontend" {
  name                         = "frontend-app"
  container_app_environment_id = azurerm_container_app_environment.env.id
  resource_group_name          = azurerm_resource_group.rg.name
  revision_mode                = "Single"

  template {
    container {
      name   = "frontend"
      image  = "myregistry.azurecr.io/frontend:latest"
      cpu    = 0.5
      memory = "1Gi"
    }
  }

  ingress {
    external_enabled = true
    target_port      = 3000
  }
}
```

---

## ğŸ”¹ outputs.tf

```hcl
output "frontend_url" {
  value = azurerm_container_app.frontend.latest_revision_fqdn
}

output "backend_url" {
  value = azurerm_container_app.backend.latest_revision_fqdn
}

output "postgres_fqdn" {
  value = azurerm_postgresql_flexible_server.db.fqdn
}
```

---

## ğŸš€ å®Ÿè¡Œæ–¹æ³•

1. **Terraform(OpenTofu)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**  
   ```bash
   sudo apt install opentofu
   ```

2. **åˆæœŸåŒ–**  
   ```bash
   cd infra/terraform
   tofu init
   ```

3. **ãƒ—ãƒ©ãƒ³ç¢ºèª**  
   ```bash
   tofu plan
   ```

4. **ãƒ‡ãƒ—ãƒ­ã‚¤**  
   ```bash
   tofu apply
   ```

5. **å‡ºåŠ›ç¢ºèª**  
   ```bash
   tofu output
   ```

---

## âœ… ã¾ã¨ã‚

- VMã§åˆ†ã‘ãŸæ§‹æˆã‚’ãã®ã¾ã¾Azureã«ç§»ã™ã¨ãã€Terraform(OpenTofu)ã§ **Container Apps + PostgreSQL Flexible Server** ã‚’ä½œã‚‹ã®ãŒæœ€å°æ§‹æˆã€‚  
- ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€CI/CDã§ **GitHub Actions â†’ ACR â†’ Terraform apply** ã®æµã‚Œã‚’çµ„ã‚ã°ã€å®Œå…¨ã«ã‚¯ãƒ©ã‚¦ãƒ‰é‹ç”¨ã«ç§»è¡Œã§ãã¾ã™ã€‚  

---

ğŸ‘‰ æ¬¡ã¯ã€**GitHub Actionsã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ACRã«pushã™ã‚‹æœ€å°ä¾‹**ã‚’è¦‹ãŸã„ã§ã™ã‹ï¼Ÿ


äº†è§£ã—ã¾ã—ãŸ âœ¨  
ã§ã¯ã€**GitHub Actionsã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦Azure Container Registry(ACR)ã«pushã™ã‚‹æœ€å°ä¾‹**ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã§ã€Terraform(OpenTofu)ã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•çš„ã«ç”¨æ„ã§ãã¾ã™ã€‚

---

## ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

```
.github/
â””â”€ workflows/
   â””â”€ docker-build.yml
```

---

## ğŸ”¹ docker-build.yml

```yaml
name: Build and Push Docker Images

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Azureã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          # secrets.AZURE_CREDENTIALS ã¯ Service Principal ã®JSONã‚’ç™»éŒ²ã—ã¦ãŠã

      # 3. ACRã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: Azure Container Registry Login
        uses: azure/docker-login@v1
        with:
          login-server: myregistry.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 4. Backendã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†push
      - name: Build and Push Backend
        run: |
          docker build -t myregistry.azurecr.io/backend:latest ./apps/backend-app1
          docker push myregistry.azurecr.io/backend:latest

      # 5. Frontendã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†push
      - name: Build and Push Frontend
        run: |
          docker build -t myregistry.azurecr.io/frontend:latest ./apps/frontend-app1
          docker push myregistry.azurecr.io/frontend:latest
```

---

## ğŸ”¹ äº‹å‰æº–å‚™

1. **Azure Container Registryä½œæˆ**
   ```bash
   az acr create --resource-group rg-dev-app --name myregistry --sku Basic
   ```

2. **Service Principalä½œæˆ**
   ```bash
   az ad sp create-for-rbac --name "github-actions-sp" \
     --role contributor \
     --scopes /subscriptions/<SUB_ID>/resourceGroups/rg-dev-app \
     --sdk-auth
   ```
   â†’ å‡ºåŠ›JSONã‚’ GitHub Secrets ã« `AZURE_CREDENTIALS` ã¨ã—ã¦ç™»éŒ²ã€‚

3. **ACRèªè¨¼æƒ…å ±ã‚’Secretsã«ç™»éŒ²**
   - `ACR_USERNAME` â†’ ACRã®ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼å  
   - `ACR_PASSWORD` â†’ ACRã®ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰  

---

## âœ… å®Ÿè¡Œã®æµã‚Œ

1. GitHubã«pushã™ã‚‹ã¨ActionsãŒèµ·å‹•  
2. Backendã¨Frontendã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰  
3. ACRã«push  
4. Terraform(OpenTofu)ã® `main.tf` ã§ `myregistry.azurecr.io/backend:latest` ã¨ `frontend:latest` ã‚’å‚ç…§  

---

## ğŸš€ ã¾ã¨ã‚

- **GitHub Actions** â†’ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†ACRã«push  
- **Terraform(OpenTofu)** â†’ ACRã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦Azure Container Appsã«ãƒ‡ãƒ—ãƒ­ã‚¤  
- ã“ã‚Œã§ **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ãŒå®Œæˆã—ã€VMã§è©¦ã—ãŸæ§‹æˆã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ç§»ã›ã¾ã™  

---

ğŸ‘‰ æ¬¡ã¯ã€**GitHub Actionsã‹ã‚‰Terraform(OpenTofu)ã‚’å‘¼ã³å‡ºã—ã¦Azureã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ä¾‹**ã‚’è¦‹ãŸã„ã§ã™ã‹ï¼Ÿ

äº†è§£ã—ã¾ã—ãŸ âœ¨  
ã§ã¯ã€**GitHub Actionsã‹ã‚‰Terraform(OpenTofu)ã‚’å‘¼ã³å‡ºã—ã¦Azureã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æœ€å°ä¾‹**ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã§ã€Œã‚³ãƒ¼ãƒ‰ã‚’push â†’ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ACRã«push â†’ Terraformã§Azureã«åæ˜ ã€ã¨ã„ã†ä¸€é€£ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Œæˆã—ã¾ã™ã€‚

---

## ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

```
.github/
â””â”€ workflows/
   â””â”€ ci-cd.yml
infra/
â””â”€ terraform/
   â”œâ”€ main.tf
   â”œâ”€ provider.tf
   â”œâ”€ variables.tf
   â””â”€ outputs.tf
```

---

## ğŸ”¹ ci-cd.yml (GitHub Actions)

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Azureã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. ACRã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: ACR Login
        uses: azure/docker-login@v1
        with:
          login-server: myregistry.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 4. Backendã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†push
      - name: Build and Push Backend
        run: |
          docker build -t myregistry.azurecr.io/backend:latest ./apps/backend-app1
          docker push myregistry.azurecr.io/backend:latest

      # 5. Frontendã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†push
      - name: Build and Push Frontend
        run: |
          docker build -t myregistry.azurecr.io/frontend:latest ./apps/frontend-app1
          docker push myregistry.azurecr.io/frontend:latest

      # 6. Terraform(OpenTofu)ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "1.7.0"

      # 7. TerraformåˆæœŸåŒ–
      - name: Terraform Init
        working-directory: infra/terraform
        run: tofu init

      # 8. Terraform Plan
      - name: Terraform Plan
        working-directory: infra/terraform
        run: tofu plan

      # 9. Terraform Apply (è‡ªå‹•æ‰¿èª)
      - name: Terraform Apply
        working-directory: infra/terraform
        run: tofu apply -auto-approve
```

---

## ğŸ”¹ Secretsã®æº–å‚™

GitHubãƒªãƒã‚¸ãƒˆãƒªã® **Settings â†’ Secrets and variables â†’ Actions** ã«ä»¥ä¸‹ã‚’ç™»éŒ²ã—ã¾ã™ï¼š

- `AZURE_CREDENTIALS` â†’ Service Principalã®JSONï¼ˆ`az ad sp create-for-rbac --sdk-auth` ã®å‡ºåŠ›ï¼‰  
- `ACR_USERNAME` â†’ ACRã®ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼å  
- `ACR_PASSWORD` â†’ ACRã®ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰  

---

## âœ… å®Ÿè¡Œã®æµã‚Œ

1. é–‹ç™ºè€…ãŒ `main` ãƒ–ãƒ©ãƒ³ãƒã« push  
2. GitHub ActionsãŒèµ·å‹•  
3. Backend/Frontendã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ACRã«push  
4. Terraform(OpenTofu)ãŒ `infra/terraform` ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€Azureã«ãƒ‡ãƒ—ãƒ­ã‚¤  
5. å‡ºåŠ›ã¨ã—ã¦ `frontend_url` ã¨ `backend_url` ãŒè¡¨ç¤ºã•ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½  

---

## ğŸš€ ã¾ã¨ã‚

- **GitHub Actions** â†’ CI/CDã®è‡ªå‹•åŒ–  
- **Docker + ACR** â†’ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ç®¡ç†  
- **Terraform(OpenTofu)** â†’ Azureãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦å†ç¾å¯èƒ½ã«  
- ã“ã‚Œã§ã€Œpushã™ã‚‹ã ã‘ã§Azureã«æœ€æ–°ç’°å¢ƒãŒãƒ‡ãƒ—ãƒ­ã‚¤ã€ã§ãã‚‹ä»•çµ„ã¿ãŒå®Œæˆã—ã¾ã™  

---

ğŸ‘‰ æ¬¡ã¯ã€ã“ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ **Proxmoxä¸Šã®VMã«å¯¾ã—ã¦ã‚‚é©ç”¨ã§ãã‚‹ã‚ˆã†ã«æ‹¡å¼µã™ã‚‹æ–¹æ³•** ã‚’è¦‹ã¦ã¿ã¾ã™ã‹ï¼Ÿ

äº†è§£ã—ã¾ã—ãŸ âœ¨  
ã§ã¯ã€**GitHub Actionsã‹ã‚‰Terraform(OpenTofu)ã‚’å‘¼ã³å‡ºã—ã¦Proxmoxä¸Šã®VMã«å¯¾ã—ã¦ã‚‚é©ç”¨ã§ãã‚‹ã‚ˆã†ã«æ‹¡å¼µã™ã‚‹æ–¹æ³•**ã‚’æ•´ç†ã—ã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã¯ã€ŒAzureç”¨ã®IaCã€ã¨ã€Œã‚ªãƒ³ãƒ—ãƒ¬VMç”¨ã®IaCã€ã‚’åˆ†ã‘ã¦ç®¡ç†ã—ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰ä¸¡æ–¹ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

---

## ğŸ¯ ã‚´ãƒ¼ãƒ«
- GitHub Actionsã§ **Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰**  
- **Azure ACRã«push**ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ç”¨ï¼‰  
- **Proxmox VMã«SSHæ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤**ï¼ˆã‚ªãƒ³ãƒ—ãƒ¬ç”¨ï¼‰  
- Terraform(OpenTofu)ã§ **Azureãƒªã‚½ãƒ¼ã‚¹**ã¨**VMãƒªã‚½ãƒ¼ã‚¹**ã‚’ã‚³ãƒ¼ãƒ‰åŒ–  

---

## ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆä¾‹

```
infra/
â”œâ”€ terraform-azure/       # Azureç”¨IaC
â”‚   â”œâ”€ main.tf
â”‚   â”œâ”€ provider.tf
â”‚   â””â”€ variables.tf
â”œâ”€ terraform-proxmox/     # Proxmoxç”¨IaC
â”‚   â”œâ”€ main.tf
â”‚   â”œâ”€ provider.tf
â”‚   â””â”€ variables.tf
â””â”€ scripts/
    â””â”€ deploy-vm.sh       # VMã«SSHã—ã¦docker-composeã‚’å®Ÿè¡Œ
.github/
â””â”€ workflows/
   â””â”€ ci-cd.yml
```

---

## ğŸ”¹ Proxmoxç”¨Terraform (ä¾‹)

`infra/terraform-proxmox/provider.tf`

```hcl
terraform {
  required_providers {
    proxmox = {
      source  = "Telmate/proxmox"
      version = "~> 3.0"
    }
  }
}

provider "proxmox" {
  pm_api_url      = "https://proxmox.example.com:8006/api2/json"
  pm_user         = var.pm_user
  pm_password     = var.pm_password
  pm_tls_insecure = true
}
```

`infra/terraform-proxmox/main.tf`

```hcl
resource "proxmox_vm_qemu" "app_vm" {
  name        = "app-server"
  target_node = "pve-node1"
  clone       = "ubuntu-24-template"
  cores       = 4
  memory      = 8192
  disk {
    size = "40G"
  }
  network {
    model = "virtio"
    bridge = "vmbr0"
  }
  ssh_user = "ubuntu"
}
```

ğŸ‘‰ ã“ã‚Œã§ Proxmox ä¸Šã« VM ã‚’IaCã§ä½œæˆã§ãã¾ã™ã€‚

---

## ğŸ”¹ GitHub Actionsæ‹¡å¼µ (ci-cd.yml)

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Docker build & push to ACR (Azureç”¨)
      - name: Build and Push Backend
        run: |
          docker build -t myregistry.azurecr.io/backend:latest ./apps/backend-app1
          docker push myregistry.azurecr.io/backend:latest

      - name: Build and Push Frontend
        run: |
          docker build -t myregistry.azurecr.io/frontend:latest ./apps/frontend-app1
          docker push myregistry.azurecr.io/frontend:latest

      # Terraform for Azure
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "1.7.0"

      - name: Terraform Apply Azure
        working-directory: infra/terraform-azure
        run: tofu apply -auto-approve

      # Terraform for Proxmox
      - name: Terraform Apply Proxmox
        working-directory: infra/terraform-proxmox
        run: tofu apply -auto-approve

      # SSH into Proxmox VM and deploy docker-compose
      - name: Deploy to Proxmox VM
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROXMOX_VM_IP }}
          username: ubuntu
          key: ${{ secrets.PROXMOX_SSH_KEY }}
          script: |
            cd /home/ubuntu/dev/infra
            docker compose pull
            docker compose up -d
```

---

## âœ… ã¾ã¨ã‚

- **Azureç”¨Terraform** â†’ Container Apps + PostgreSQL  
- **Proxmoxç”¨Terraform** â†’ VMä½œæˆ  
- **GitHub Actions** â†’  
  1. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼†ACRã«push  
  2. Terraform(OpenTofu)ã§Azureãƒªã‚½ãƒ¼ã‚¹ã‚’apply  
  3. Terraform(OpenTofu)ã§Proxmox VMã‚’apply  
  4. SSHã§VMã«å…¥ã‚Šã€docker-composeã‚’èµ·å‹•  

---

ğŸ‘‰ ã“ã‚Œã§ã€ŒåŒã˜CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰Azureã¨Proxmoxä¸¡æ–¹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  

æ¬¡ã¯ã€**Proxmox VMã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­è¨ˆï¼ˆLANå†…ã‚¢ã‚¯ã‚»ã‚¹ã€å¤–éƒ¨å…¬é–‹ã€NATã®æ‰±ã„ï¼‰**ã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ





































æ¬¡ã¯ã€**Terraform(OpenTofu)ã§ Azure ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æœ€å°ã‚³ãƒ¼ãƒ‰ä¾‹**ã‚’è¦‹ã¦ã¿ã¾ã™ã‹ï¼Ÿ